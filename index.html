<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI投资范式Agent</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* Add styles for login/user info */
        .auth-section {
            display: flex;
            align-items: center;
            margin-left: auto; /* Pushes it to the right */
            padding-right: 15px; /* Reduced padding a bit */
            flex-shrink: 0; /* Prevent shrinking if header space is tight */
            gap: 8px; /* Space between auth elements if they wrap, or between avatar/name/button */
        }

        #loginBtn, #logoutBtn {
            background-color: #007bff; /* Changed to a more common blue for login */
            color: white;
            padding: 8px 12px; /* Reduced padding */
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em; /* Slightly smaller font */
            white-space: nowrap; /* Prevent button text from wrapping */
            display: flex; /* To align icon and text */
            align-items: center; /* To align icon and text */
        }

        #loginBtn i, #logoutBtn i {
            margin-right: 5px;
        }
        
        #loginBtn {
            background-color: #28a745; /* GitHub-like green or your preferred color */
        }

        #logoutBtn {
            background-color: #dc3545; /* Common red for logout/danger */
        }

        #githubUserInfo {
            display: flex;
            align-items: center;
            color: var(--text-color);
            gap: 8px; /* Space between avatar, name, and logout button */
        }

        #githubUserAvatar {
            width: 28px; /* Slightly smaller avatar */
            height: 28px;
            border-radius: 50%;
            border: 1px solid #ccc;
            flex-shrink: 0; /* Prevent avatar from shrinking */
        }

        #githubUserName {
            font-weight: normal; /* Normal weight might look cleaner */
            font-size: 0.9em;
            white-space: nowrap; /* Prevent name from wrapping */
            overflow: hidden; /* Hide overflow if name is too long */
            text-overflow: ellipsis; /* Add ellipsis if name is too long */
            max-width: 100px; /* Adjust as needed, limits name width */
        }

        .hidden {
            display: none !important;
        }

        #authErrorMessages {
            color: red;
            font-size: 0.8em;
            /* Position it differently if needed, or remove if not desired permanently */
            /* For single line, we might remove it or make it appear on hover/click */
            display: none; /* Hidden by default to save space, show on error */
        }

        .main-header {
            display: flex;
            align-items: center;
            /* justify-content: space-between; (optional, if you want space-between globally) */
        }
        
        .main-header nav {
            /* Ensure nav doesn't push auth section too much */
            /* flex-grow: 1; (optional, if logo and nav should take available space) */
        }

        /* Responsive adjustments if needed */
        @media (max-width: 768px) { /* Example breakpoint */
            .auth-section {
                /* Could allow wrapping or hide username for very small screens */
                /* flex-wrap: wrap; */
                /* justify-content: flex-end; */
            }
            #githubUserName {
                /* display: none; /* Hide username on very small screens */
            }
            .main-header nav {
                /* Potentially hide some nav items or make them a dropdown */
            }
        }

    </style>
</head>
<body>
    <div class="page-container">
        <header class="main-header">
            <div class="logo-title">
                <i class="fas fa-brain"></i>
                <h1>AI投资范式Agent</h1>
            </div>
            <nav>
                <a href="index.html" class="active-nav"><i class="fas fa-users-cog"></i> AI投资组合</a>
                <a href="PotScoreFundAnalytics.html"><i class="fas fa-chart-line"></i> AI投资量化</a>
                <a href="#apiSettingsModal" onclick="openApiSettingsModal()"><i class="fas fa-cog"></i> API设置</a>
            </nav>
            <!-- GitHub Auth Section -->
            <div class="auth-section">
                <div id="githubUserInfo" class="hidden">
                    <img id="githubUserAvatar" src="" alt="User Avatar">
                    <span id="githubUserName"></span>
                    <button id="logoutBtn" title="Logout"><i class="fas fa-sign-out-alt"></i> 登出</button>
                </div>
                <button id="loginBtn" title="Login with GitHub"><i class="fab fa-github"></i> GitHub 登录</button>
                <!-- Error messages div might be better placed elsewhere if space is critical -->
                <!-- Or shown dynamically, for now it's hidden by default -->
                <div id="authErrorMessages"></div>
            </div>
        </header>

        <!-- ... (rest of your HTML body remains the same) ... -->

        <div class="content-area">
            <div class="tabs-main">
                <button class="tab-link-main active" onclick="openMainTab(event, 'aiAgents')"><i class="fas fa-user-tie"></i> AI投资组合Agent</button>
                <button class="tab-link-main" onclick="openMainTab(event, 'myPortfolio')"><i class="fas fa-arrow-trend-up"></i> 我的投资组合</button>
            </div>

            <div id="aiAgents" class="main-tab-content active">
                <div class="agent-cards-container">
                    <!-- Agent Card 1: 大智 (Value Investing) -->
                    <div class="agent-card value-agent-card">
                        <div class="agent-profile">
                            <img src="images/female_avatar.png" alt="大智" class="agent-photo" id="agent1Photo">
                            <h2 class="agent-name" id="agent1NameDisplay">大智</h2>
                            <p class="agent-role">负责: <span id="agent1RoleDisplay">稳健智远</span> 投资组合</p>
                        </div>
                        <div class="agent-details">
                            <h3><i class="fas fa-lightbulb"></i> 核心投资理念</h3>
                            <p id="agent1Logic" class="core-logic">
                                我的投资哲学强调深入理解企业的内在价值，寻找那些拥有强大护城河、稳定盈利能力和优秀管理层的公司。
                                我倾向于长期持有，并相信市场的短期波动最终会回归到企业的真实价值。在分析时，我会特别关注公司的财务健康状况、行业地位以及宏观经济环境。
                                量化因子方面，我会审视标的动能(PotScore)以判断市场情绪和短期趋势，并结合主力资金流入情况，确保我的价值判断得到市场资金的佐证。
                            </p>
                            
                            <div class="agent-section">
                                <h4><i class="fas fa-clipboard-list"></i> 自选股票分析池</h4>
                                <div class="stock-management">
                                    <input type="text" id="agent1StockInput" placeholder="代码 名称 (如: 600519 茅台)">
                                    <button onclick="addStockToPool('agent1')"><i class="fas fa-plus-circle"></i> 添加到分析池</button>
                                </div>
                                <ul id="agent1StockPoolList" class="stock-list"></ul>
                            </div>

                             <div class="agent-section analysis-section">
                                <h4><i class="fas fa-search-dollar"></i> 股票分析</h4>
                                <div class="stock-analysis-controls">
                                    <select id="agent1StockSelect" class="stock-select">
                                        <option value="">--- 从分析池选择 ---</option>
                                    </select>
                                    <span>或</span>
                                    <input type="text" id="agent1AnalysisInput" placeholder="输入新股票代码/名称分析">
                                    <button onclick="analyzeStockForAgent('agent1')"><i class="fas fa-cogs"></i> 分析股票</button>
                                </div>
                                <div class="analysis-output"> <!-- This is the parent for the textarea and button -->
                                    <h5>分析报告:</h5>
                                    <textarea id="agent1AnalysisOutput" rows="6" readonly placeholder="分析结果将在此显示..."></textarea>
                                    <!-- "View Report" button will be dynamically added here by JS -->
                                </div>
                            </div>

                            <div class="agent-section agent-portfolio-section">
                                <h4><i class="fas fa-briefcase"></i> 稳健智远投资组合</h4>
                                <div class="agent-portfolio-controls">
                                    <button onclick="exportAgentPortfolioToExcel('agent1')"><i class="fas fa-file-excel"></i> 导出组合</button>
                                    <button onclick="openPerformanceModal('agent1')"><i class="fas fa-chart-pie"></i> 收益测算</button>
                                </div>
                                <table id="agent1PortfolioTable" class="agent-portfolio-table-style">
                                    <thead>
                                        <tr>
                                            <th>股票代码/名称</th>
                                            <th>配置比例 (%) <button class="balance-agent-portfolio-btn" data-agentid="agent1" title="自动平衡比例"><i class="fas fa-magic"></i></button></th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Agent 1 Portfolio items will be added here -->
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <td class="total-label">总计:</td>
                                            <td id="agent1PortfolioTotalAllocation" class="total-value">0%</td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                </table>
                                 <div class="stock-management add-to-agent-portfolio">
                                    <!-- Section for adding from analysis pool -->
                                    <div class="add-from-pool-section">
                                        <select id="agent1AddFromPoolSelect" class="stock-select">
                                            <option value="">--- 从分析池选择添加到组合 ---</option>
                                        </select>
                                        <button onclick="addSelectedStockFromPoolToAgentPortfolio('agent1')" title="添加选中股票到组合">
                                            <i class="fas fa-level-down-alt"></i> 添加选中
                                        </button>
                                    </div>
                                    
                                    <div class="or-divider">或</div>

                                    <!-- Section for manual input -->
                                    <div class="manual-add-section">
                                        <input type="text" id="agent1AddToPortfolioInput" placeholder="手动输入代码/名称添加">
                                        <button onclick="addStockToAgentPortfolio('agent1')">
                                            <i class="fas fa-plus-circle"></i> 手动添加
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Agent Card 2: 大成 (Growth Investing) -->
                    <div class="agent-card growth-agent-card">
                        <div class="agent-profile">
                            <img src="images/male_avatar.png" alt="大成" class="agent-photo" id="agent2Photo">
                            <h2 class="agent-name" id="agent2NameDisplay">大成</h2>
                            <p class="agent-role">负责: <span id="agent2RoleDisplay">锐进先锋</span> 投资组合</p>
                        </div>
                        <div class="agent-details">
                            <h3><i class="fas fa-lightbulb"></i> 核心投资理念</h3>
                            <p id="agent2Logic" class="core-logic">
                                我专注于发掘具有颠覆性创新能力和巨大增长潜力的公司，尤其是在人工智能、区块链、基因编辑等前沿科技领域。
                                我相信技术进步是驱动未来经济增长的核心动力，并乐于承担较高风险以追求超额回报。我的分析侧重于公司的技术壁垒、市场规模、以及其商业模式的可扩展性。
                                对于量化因子，我会关注标的动能(PotScore)来捕捉市场对创新趋势的早期反应，同时分析主力资金流入情况，以验证增长故事是否获得聪明资金的认可。
                            </p>
                            
                            <div class="agent-section">
                                <h4><i class="fas fa-clipboard-list"></i> 自选股票分析池</h4>
                                <div class="stock-management">
                                    <input type="text" id="agent2StockInput" placeholder="代码 名称 (如: 300750 宁德时代)">
                                    <button onclick="addStockToPool('agent2')"><i class="fas fa-plus-circle"></i> 添加到分析池</button>
                                </div>
                                <ul id="agent2StockPoolList" class="stock-list"></ul>
                            </div>

                             <div class="agent-section analysis-section">
                                <h4><i class="fas fa-search-dollar"></i> 股票分析</h4>
                                <div class="stock-analysis-controls">
                                    <select id="agent2StockSelect" class="stock-select">
                                        <option value="">--- 从分析池选择 ---</option>
                                    </select>
                                    <span>或</span>
                                    <input type="text" id="agent2AnalysisInput" placeholder="输入新股票代码/名称分析">
                                    <button onclick="analyzeStockForAgent('agent2')"><i class="fas fa-cogs"></i> 分析股票</button>
                                </div>
                                <div class="analysis-output"> <!-- This is the parent for the textarea and button -->
                                    <h5>分析报告:</h5>
                                    <textarea id="agent2AnalysisOutput" rows="6" readonly placeholder="分析结果将在此显示..."></textarea>
                                    <!-- "View Report" button will be dynamically added here by JS -->
                                </div>
                            </div>

                            <div class="agent-section agent-portfolio-section">
                                <h4><i class="fas fa-briefcase"></i> 锐进先锋投资组合</h4>
                                <div class="agent-portfolio-controls">
                                    <button onclick="exportAgentPortfolioToExcel('agent2')"><i class="fas fa-file-excel"></i> 导出组合</button>
                                    <button onclick="openPerformanceModal('agent2')"><i class="fas fa-chart-pie"></i> 收益测算</button>
                                </div>
                                <table id="agent2PortfolioTable" class="agent-portfolio-table-style">
                                    <thead>
                                        <tr>
                                            <th>股票代码/名称</th>
                                            <th>配置比例 (%) <button class="balance-agent-portfolio-btn" data-agentid="agent2" title="自动平衡比例"><i class="fas fa-magic"></i></button></th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Agent 2 Portfolio items -->
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <td class="total-label">总计:</td>
                                            <td id="agent2PortfolioTotalAllocation" class="total-value">0%</td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                </table>
                                <div class="stock-management add-to-agent-portfolio">
                                    <!-- Section for adding from analysis pool -->
                                    <div class="add-from-pool-section">
                                        <select id="agent2AddFromPoolSelect" class="stock-select">
                                            <option value="">--- 从分析池选择添加到组合 ---</option>
                                        </select>
                                        <button onclick="addSelectedStockFromPoolToAgentPortfolio('agent2')" title="添加选中股票到组合">
                                            <i class="fas fa-level-down-alt"></i> 添加选中
                                        </button>
                                    </div>

                                    <div class="or-divider">或</div>
                                    
                                    <!-- Section for manual input -->
                                    <div class="manual-add-section">
                                        <input type="text" id="agent2AddToPortfolioInput" placeholder="手动输入代码/名称添加">
                                        <button onclick="addStockToAgentPortfolio('agent2')">
                                            <i class="fas fa-plus-circle"></i> 手动添加
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="myPortfolio" class="main-tab-content">
                <div class="my-portfolio-header">
                    <h2>
                        <i class="fas fa-briefcase"></i> 
                        <span id="myPortfolioTitleText" contenteditable="false">我的投资组合</span>
                        <button id="editMyPortfolioTitleBtn" class="edit-title-btn" title="编辑组合名称"><i class="fas fa-pencil-alt"></i></button>
                    </h2>
                    <div class="my-portfolio-controls">
                        <button onclick="syncStocksToMyPortfolio()"><i class="fas fa-sync-alt"></i> 同步AI智能体组合</button>
                        <button onclick="exportMyPortfolioToExcel()"><i class="fas fa-file-excel"></i> 导出我的组合</button>
                        <button onclick="openPerformanceModal('myPortfolio')"><i class="fas fa-chart-pie"></i> 我的组合收益测算</button>
                    </div>
                </div>
                <p class="my-portfolio-description">以下是根据AI智能体建议及您的自定义配置形成的投资组合。您可以调整各项资产的比例。</p>
                
                <table id="myPortfolioTable">
                    <thead>
                        <tr>
                            <th>股票代码/名称</th>
                            <th>来源</th>
                            <th>建议比例 (%)</th>
                            <th>我的配置 (%) <button id="balancePortfolioBtn" title="自动平衡未配置股票的比例"><i class="fas fa-magic"></i></button></th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Portfolio items will be added here -->
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3" class="total-label">总计:</td>
                            <td id="myPortfolioTotalAllocation" class="total-value">0%</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <footer>
            <p>© 2025 AI范式进化. 保留所有权利。</p>
            <p>投资有风险，入市需谨慎。本内容仅供参考，不构成任何投资建议。</p>
        </footer>
    </div>

    <!-- API Settings Modal -->
    <div id="apiSettingsModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeApiSettingsModal()">×</span>
            <h2><i class="fas fa-cog"></i> API及模型设置</h2>
            <div class="settings-form">
                <div class="form-group">
                    <label for="apiEndpointSelect"><i class="fas fa-server"></i> 模型接入点 (API Endpoint):</label>
                    <select id="apiEndpointSelect" class="stock-select">
                        <!-- Options will be populated by JS -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="apiKey"><i class="fas fa-key"></i> API Key:</label>
                    <input type="password" id="apiKey" placeholder="输入您的API Key">
                </div>
                <div class="form-group">
                    <label for="apiModelSelect"><i class="fas fa-robot"></i> 模型选择:</label>
                    <select id="apiModelSelect" class="stock-select">
                        <!-- Options will be populated by JS based on endpoint selection -->
                    </select>
                </div>
                <button onclick="saveApiSettings()"><i class="fas fa-save"></i> 保存设置</button>
                <button onclick="clearApiSettings()" class="danger-btn" style="margin-top: 10px;"><i class="fas fa-trash-alt"></i> 清除已存API信息</button>
                <p id="settingsStatus" class="status-message"></p>
            </div>
        </div>
    </div>

    <!-- Performance Backtest Modal -->
    <div id="performanceModal" class="modal">
        <div class="modal-content large">
            <span class="close-button" onclick="closePerformanceModal()">×</span>
            <h2 id="performanceModalTitle"><i class="fas fa-chart-pie"></i> 投资组合收益测算评估</h2>
            <div class="performance-controls">
                <label for="backtestStartDate">开始日期:</label>
                <input type="date" id="backtestStartDate">
                <label for="backtestEndDate">结束日期:</label>
                <input type="date" id="backtestEndDate">
                <button onclick="runBacktest()"><i class="fas fa-play-circle"></i> 开始测算</button>
            </div>
            <div id="backtestResults" class="backtest-results-area">
                <p>请选择日期范围并开始测算。注意：此功能为演示，实际回测需要历史数据和复杂计算。</p>
                <canvas id="performanceChart" style="display:none;"></canvas>
            </div>
        </div>
    </div>

    <!-- Analysis Report Modal -->
    <div id="analysisReportModal" class="modal">
        <div class="modal-content large">
            <span class="close-button" onclick="closeAnalysisReportModal()">×</span>
            <h2 id="analysisReportModalTitle"><i class="fas fa-file-alt"></i> AI分析报告</h2>
            <div class="analysis-report-modal-controls">
                <button onclick="copyAnalysisReportToClipboard()"><i class="fas fa-copy"></i> 复制报告内容</button>
            </div>
            <div id="analysisReportModalBody" class="analysis-report-body">
                <!-- Report content will be injected here by JavaScript -->
            </div>
        </div>
    </div>

    <script src="scripts/potfunddatarender.js"></script> <!-- LOAD THIS FIRST -->
    <script src="scripts/portfolio_agent.js"></script>   <!-- LOAD THIS SECOND -->
    <script>
        // GitHub Auth Constants -  REPLACE 'YOUR_GITHUB_CLIENT_ID'
        const GITHUB_CLIENT_ID = 'Ov23liAr5gYJACq7QZ1p'; 
        const REDIRECT_URI = 'https://aipeinvestmentagent.pages.dev/callback.html'; // Must match GitHub App and Function
        const GITHUB_AUTH_SCOPE = 'read:user user:email'; // Permissions

        // DOM Elements for Auth
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const githubUserInfoDiv = document.getElementById('githubUserInfo');
        const githubUserAvatarImg = document.getElementById('githubUserAvatar');
        const githubUserNameSpan = document.getElementById('githubUserName');
        const authErrorMessagesDiv = document.getElementById('authErrorMessages');

        function generateRandomState() {
            return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        }

        async function fetchGitHubUserInfoFromApi(accessToken) {
            if (authErrorMessagesDiv) authErrorMessagesDiv.textContent = ''; 
            try {
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${accessToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`GitHub API error: ${errorData.message || response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Error fetching GitHub user info:', error);
                if (authErrorMessagesDiv) authErrorMessagesDiv.textContent = `无法获取用户信息: ${error.message}`;
                return null;
            }
        }

        function displayLoggedInUser(userData) {
            if (userData && githubUserAvatarImg && githubUserNameSpan && githubUserInfoDiv && loginBtn && logoutBtn) {
                githubUserAvatarImg.src = userData.avatar_url || 'images/default_avatar.png'; 
                githubUserNameSpan.textContent = userData.name || userData.login; 
                githubUserInfoDiv.classList.remove('hidden');
                loginBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
                 if (authErrorMessagesDiv) authErrorMessagesDiv.style.display = 'none'; // Hide error div on success
            } else {
                 console.warn("User data or UI elements for user info are missing.");
                 handleLogout(); 
            }
        }

        function updateAuthUI() {
            const accessToken = localStorage.getItem('github_access_token');
            const storedUserInfo = localStorage.getItem('github_user_info');
            if (authErrorMessagesDiv) authErrorMessagesDiv.textContent = '';

            if (accessToken && storedUserInfo) {
                try {
                    const userData = JSON.parse(storedUserInfo);
                    displayLoggedInUser(userData);
                } catch (e) {
                    console.error("Error parsing stored user info:", e);
                    if (authErrorMessagesDiv) {
                        authErrorMessagesDiv.textContent = "登录会话已损坏，请重新登录。";
                        authErrorMessagesDiv.style.display = 'block';
                    }
                    handleLogout(); 
                }
            } else if (accessToken && !storedUserInfo) {
                console.log("Access token found, but user info missing. Fetching...");
                fetchGitHubUserInfoFromApi(accessToken).then(userData => {
                    if (userData) {
                        localStorage.setItem('github_user_info', JSON.stringify(userData));
                        displayLoggedInUser(userData);
                    } else {
                        if (authErrorMessagesDiv) {
                            authErrorMessagesDiv.textContent = "无法验证登录会话，请重新登录。";
                            authErrorMessagesDiv.style.display = 'block';
                        }
                        handleLogout();
                    }
                });
            }
            else { 
                if (githubUserInfoDiv && loginBtn && logoutBtn) {
                    githubUserInfoDiv.classList.add('hidden');
                    loginBtn.classList.remove('hidden');
                    logoutBtn.classList.add('hidden');
                }
                if (authErrorMessagesDiv) authErrorMessagesDiv.style.display = 'none'; // Hide if not logged in and no specific error
            }
        }

        function handleLogin() {
            if (!GITHUB_CLIENT_ID || GITHUB_CLIENT_ID === 'YOUR_GITHUB_CLIENT_ID') {
                alert('GitHub Client ID 未在 index.html 中配置. 请联系网站管理员。');
                if (authErrorMessagesDiv) {
                    authErrorMessagesDiv.textContent = '客户端配置错误。';
                    authErrorMessagesDiv.style.display = 'block';
                }
                return;
            }
            const state = generateRandomState();
            localStorage.setItem('oauth_state', state);

            const authUrl = `https://github.com/login/oauth/authorize?client_id=${GITHUB_CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${encodeURIComponent(GITHUB_AUTH_SCOPE)}&state=${state}`;
            window.location.href = authUrl;
        }

        function handleLogout() {
            localStorage.removeItem('github_access_token');
            localStorage.removeItem('github_user_info');
            localStorage.removeItem('oauth_state'); 
            updateAuthUI(); 
        }

        if (loginBtn) loginBtn.addEventListener('click', handleLogin);
        if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);


        document.addEventListener('DOMContentLoaded', async () => {
            updateAuthUI(); 

            if (typeof window.allStockDataGlobalPromise === 'undefined') {
                console.log("AI Portfolio Page (index.html): Initializing Excel data load...");
                try {
                    if (typeof loadAndProcessExcelData === "function") {
                        window.allStockDataGlobalPromise = loadAndProcessExcelData();
                        await window.allStockDataGlobalPromise;
                        console.log("AI Portfolio Page (index.html): Excel data load attempt complete.");
                    } else {
                        console.error("loadAndProcessExcelData function not found. Ensure potfunddatarender.js is loaded correctly.");
                        alert("股票基础数据加载脚本 (potfunddatarender.js) 未找到。");
                    }
                } catch (error) {
                    console.error("Error loading Excel data on AI Portfolio page:", error);
                    alert("股票基础数据加载失败，部分功能可能受限。请尝试刷新或检查AI投资量化页面是否正常。");
                }
            } else {
                 console.log("AI Portfolio Page (index.html): Excel data likely already loaded or being loaded via existing promise.");
                 try {
                    await window.allStockDataGlobalPromise; 
                    console.log("AI Portfolio Page (index.html): Existing Excel data promise resolved.");
                 } catch (error) {
                    console.error("Error awaiting existing Excel data promise on AI Portfolio page:", error);
                    alert("等待现有股票基础数据加载时出错。");
                 }
            }
        });
    </script>
</body>
</html>
