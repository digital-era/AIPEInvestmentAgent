<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI投资范式Agent</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* ... (之前的 .auth-section, #loginBtn, #githubUserInfo 等样式保持不变) ... */
        .auth-section { display: flex; align-items: center; padding-right: 15px; flex-shrink: 0; gap: 8px; }
        #loginBtn, #logoutBtn { background-color: #007bff; color: white; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em; white-space: nowrap; display: flex; align-items: center; }
        #loginBtn { background-color: #28a745; }
        #logoutBtn { background-color: #dc3545; }
        #loginBtn i, #logoutBtn i { margin-right: 5px; }
        #githubUserInfo { display: flex; align-items: center; color: var(--text-color); gap: 8px; }
        #githubUserAvatar { width: 28px; height: 28px; border-radius: 50%; border: 1px solid #ccc; flex-shrink: 0; }
        #githubUserName { font-weight: normal; font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100px; }
        .hidden { display: none !important; }
        #authErrorMessages { color: red; font-size: 0.8em; display: none; }

        .main-header {
            display: flex;
            align-items: center;
            flex-wrap: nowrap; /* 大屏幕默认不换行 */
            padding: 10px 15px;
        }
        .logo-title {
            margin-right: 20px; /* Logo 和导航之间的间距 */
            flex-shrink: 0; /* 防止logo缩小 */
        }

        .main-header nav { /* 主导航，只包含核心链接 */
            display: flex;
            align-items: center;
        }
        .main-header nav a {
            white-space: nowrap;
            padding: 10px 12px;
            text-decoration: none;
            color: var(--text-color);
            font-size: 0.95em;
        }
        .main-header nav a.nav-link-api-settings { /* 大屏幕时 API 设置也在这个 nav 里 */
            /* 样式与其他导航链接一致 */
        }

        /* 包裹 API设置 和 Auth区域 的容器，这个容器本身会在必要时换行 */
        .secondary-nav-auth-wrapper {
            display: flex; /* 让内部的 API设置 和 Auth区域 水平排列 */
            align-items: center;
            margin-left: auto; /* 将这个组合推到最右边 */
        }
        .secondary-nav-auth-wrapper .api-settings-link { /* API 设置链接的特定样式 */
            white-space: nowrap;
            padding: 10px 12px;
            text-decoration: none;
            color: var(--text-color);
            font-size: 0.95em;
            margin-right: 15px; /* 和Auth区域的间距 */
        }
         .secondary-nav-auth-wrapper .api-settings-link i {
            margin-right: 5px;
        }


        /* 媒体查询 - 针对小屏幕 (手机端) */
        /* 断点调整为 768px，你可以根据需要修改 */
        @media (max-width: 768px) { 
            .main-header {
                flex-wrap: wrap; 
            }

            .logo-title {
                /* 在小屏幕上，logo自己占一些空间，右边留给导航 */
                margin-right: auto; /* 将logo推到最左，其他内容（nav）推到右边 */
            }

            .main-header nav { 
                 /* nav现在和logo在同一行，但内容会靠右 */
                 flex-grow: 0; /* 不再让它填满，按内容宽度 */
                 margin-right: 0; /* 清除大屏幕的auto margin (如果有的话) */
            }
            /* 确保导航项之间有一定间隔 */
            .main-header nav a {
                padding: 8px 5px; /* 进一步缩小padding */
                font-size: 0.85em; /* 进一步缩小字体 */
            }
            /* 将 "AI投资量化" 推到其容器（nav）的右边 */
            /* 这个可能不需要了，因为nav本身不是100%宽度，而是和logo同行靠右 */
            /* .main-header nav a:nth-child(2) {
                margin-left: auto; 
            } */
            
            .secondary-nav-auth-wrapper {
                width: 100%; 
                margin-left: 0; 
                margin-top: 8px; /* 与上一行的间距 */
                justify-content: flex-end; /* !!! 让整个wrapper里的内容靠右 !!! */
                padding: 0; /* 移除左右padding，让内容自然靠右 */
            }
            
            .secondary-nav-auth-wrapper .api-settings-link {
                margin-right: 8px; /* API设置和Auth区域的间距 */
                padding: 6px 8px; 
                font-size: 0.8em; /* 缩小字体 */
            }
             .secondary-nav-auth-wrapper .api-settings-link i,
             .auth-section #loginBtn i, .auth-section #logoutBtn i {
                margin-right: 3px; /* 缩小图标右边距 */
            }
            
            .secondary-nav-auth-wrapper .auth-section {
                padding-right: 0; 
            }
            .auth-section #loginBtn, .auth-section #logoutBtn {
                font-size: 0.8em; /* 缩小登录/登出按钮字体 */
                padding: 6px 8px; /* 缩小登录/登出按钮padding */
            }
            #githubUserAvatar {
                width: 24px; height: 24px;
            }
            #githubUserName {
                max-width: 50px; /* 进一步限制用户名宽度 */
                font-size: 0.8em;
            }
            /* Portfolio actions 按钮调整 */
            .portfolio-actions {
                margin-left: 8px; /* 与Auth区域的间距 */
            }
            .portfolio-actions button {
                font-size: 0.75em; /* 非常小的字体 */
                padding: 5px 6px; /* 非常小的padding */
            }
        }

         @media (max-width: 480px) { /* 更小屏幕的额外调整 */
            .logo-title {
                margin-right: 10px; /* 调整logo和导航的间距 */
            }
            .logo-title h1 { font-size: 1em; } /* 进一步缩小标题 */
            .logo-title i { font-size: 1em; }

            .main-header nav a {
                font-size: 0.8em; 
                padding: 6px 3px; /* 非常小的padding */
            }
            /* 在480px以下，如果导航项还是太多，考虑隐藏文字只留图标 */
            .main-header nav a .fa-users-cog, .main-header nav a .fa-chart-line { /* 选择图标 */
                /* font-size: 1.2em; /* 稍微放大图标 */ 
            }
            /* .main-header nav a span { display: none; } /* 隐藏文字，需要HTML配合 <i class="..."></i><span>文字</span> */


            .secondary-nav-auth-wrapper .api-settings-link,
            .auth-section #loginBtn, .auth-section #logoutBtn,
            .portfolio-actions button {
                font-size: 0.7em; /* 极限缩小字体 */
                padding: 4px 5px; 
            }
            .secondary-nav-auth-wrapper .api-settings-link i,
            .auth-section #loginBtn i, .auth-section #logoutBtn i,
            .portfolio-actions button i {
                margin-right: 2px;
            }

            #githubUserAvatar {
                width: 20px; height: 20px;
            }
            #githubUserName {
                 display: none; 
            }
            .logo-title h1 {
                font-size: 1.1em; /* 缩小标题字号 */
            }
            .logo-title i {
                font-size: 1.1em; /* 缩小图标字号 */
            }
         }
		 
         /* Portfolio actions and loading indicator (from previous R2 solution) */
        .portfolio-actions { margin-left: 10px; display:none; align-items: center; gap: 5px;}
        .portfolio-actions button { font-size: 0.8em; padding: 6px 10px; }
        #portfolioLoadingIndicator { font-size: 0.8em; color: var(--text-muted); margin-left: 10px;}
    </style>
</head>
<body>
    <div class="page-container">
        <header class="main-header">
            <div class="logo-title">
                <i class="fas fa-brain"></i>
                <h1>AI投资范式Agent</h1>
            </div>

            <nav> <!-- 主导航，只包含核心链接 -->
                <a href="index.html" class="active-nav"><i class="fas fa-users-cog"></i> AI投资组合</a>
                <a href="PotScoreFundAnalytics.html"><i class="fas fa-chart-line"></i> AI投资量化</a>
            </nav>
            <!-- 新的 wrapper，包含 API 设置和 Auth Section -->
            <div class="secondary-nav-auth-wrapper">
                <a href="#apiSettingsModal" onclick="openApiSettingsModal()" class="api-settings-link"><i class="fas fa-cog"></i> 设置</a>
                <div class="auth-section">
                    <div id="githubUserInfo" class="hidden">
                        <img id="githubUserAvatar" src="" alt="User Avatar">
                        <span id="githubUserName"></span>
                        <button id="logoutBtn" title="Logout"><i class="fas fa-sign-out-alt"></i> 登出</button>
                    </div>
                    <button id="loginBtn" title="Login with GitHub"><i class="fab fa-github"></i> GitHub 登录</button>
                    <div id="authErrorMessages"></div>
                </div>
                <!-- Portfolio Actions (for R2 solution) -->
                <div class="portfolio-actions">
                    <button onclick="generateClientSideExcelDownload()" title="下载当前编辑的组合数据到本地Excel文件"><i class="fas fa-download"></i> 组合</button>
                    <button onclick="forceSyncToR2()" title="将当前编辑的组合数据保存到云端" style="margin-left: 5px;"><i class="fas fa-cloud-upload-alt"></i> 保存</button>
                    <span id="portfolioLoadingIndicator" style="display:none;">处理中...</span>
                </div>
            </div>
        </header>

        <!-- ... (rest of your HTML body remains the same, no need for duplicated auth elements) ... -->
        <div class="content-area">
            <div class="tabs-main">
                <button class="tab-link-main active" onclick="openMainTab(event, 'aiAgents')"><i class="fas fa-user-tie"></i> AI投资组合Agent</button>
                <button class="tab-link-main" onclick="openMainTab(event, 'myPortfolio')"><i class="fas fa-arrow-trend-up"></i> 我的投资组合</button>
            </div>

            <div id="aiAgents" class="main-tab-content active">
                <div class="agent-cards-container">
                    <!-- Agent Card 1: 大智 (Value Investing) -->
                    <div class="agent-card value-agent-card">
                        <div class="agent-profile">
                            <img src="images/female_avatar.png" alt="大智" class="agent-photo" id="agent1Photo">
                            <h2 class="agent-name" id="agent1NameDisplay">大智</h2>
                            <p class="agent-role">负责: <span id="agent1RoleDisplay">稳健智远</span> 投资组合</p>
                        </div>
                        <div class="agent-details">
                            <h3><i class="fas fa-lightbulb"></i> 核心投资理念</h3>
                            <p id="agent1Logic" class="core-logic">
                                我的投资哲学强调深入理解企业的内在价值，寻找那些拥有强大护城河、稳定盈利能力和优秀管理层的公司。
                                我倾向于长期持有，并相信市场的短期波动最终会回归到企业的真实价值。在分析时，我会特别关注公司的财务健康状况、行业地位以及宏观经济环境。
                                量化因子方面，我会审视标的动能(PotScore)以判断市场情绪和短期趋势，并结合主力资金流入情况，确保我的价值判断得到市场资金的佐证。
                            </p>
                            
                            <div class="agent-section">
                                <h4><i class="fas fa-clipboard-list"></i> 自选股票分析池</h4>
                                <div class="stock-management">
                                    <input type="text" id="agent1StockInput" placeholder="代码 名称 (如: 600519 茅台)">
                                    <button onclick="addStockToPool('agent1')"><i class="fas fa-plus-circle"></i> 添加到分析池</button>
                                </div>
                                <ul id="agent1StockPoolList" class="stock-list"></ul>
                            </div>

                             <div class="agent-section analysis-section">
                                <h4><i class="fas fa-search-dollar"></i> 股票分析</h4>
                                <div class="stock-analysis-controls">
                                    <select id="agent1StockSelect" class="stock-select">
                                        <option value="">--- 从分析池选择 ---</option>
                                    </select>
                                    <span>或</span>
                                    <input type="text" id="agent1AnalysisInput" placeholder="输入新股票代码/名称分析">
                                    <button onclick="analyzeStockForAgent('agent1')"><i class="fas fa-cogs"></i> 分析股票</button>
                                </div>
                                <div class="analysis-output"> <!-- This is the parent for the textarea and button -->
                                    <h5>分析报告:</h5>
                                    <textarea id="agent1AnalysisOutput" rows="6" readonly placeholder="分析结果将在此显示..."></textarea>
                                    <!-- "View Report" button will be dynamically added here by JS -->
                                </div>
                            </div>

                            <div class="agent-section agent-portfolio-section">
                                <h4><i class="fas fa-briefcase"></i> 稳健智远投资组合</h4>
                                <div class="agent-portfolio-controls">
                                    <button onclick="exportAgentPortfolioToExcel('agent1')"><i class="fas fa-file-excel"></i> 导出组合</button>
                                    <button onclick="openPerformanceModal('agent1')"><i class="fas fa-chart-pie"></i> 收益测算</button>
                                </div>
                                <table id="agent1PortfolioTable" class="agent-portfolio-table-style">
                                    <thead>
                                        <tr>
                                            <th>股票代码/名称</th>
                                            <th>配置比例 (%) <button class="balance-agent-portfolio-btn" data-agentid="agent1" title="自动平衡比例"><i class="fas fa-magic"></i></button></th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Agent 1 Portfolio items will be added here -->
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <td class="total-label">总计:</td>
                                            <td id="agent1PortfolioTotalAllocation" class="total-value">0%</td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                </table>
                                 <div class="stock-management add-to-agent-portfolio">
                                    <!-- Section for adding from analysis pool -->
                                    <div class="add-from-pool-section">
                                        <select id="agent1AddFromPoolSelect" class="stock-select">
                                            <option value="">--- 从分析池选择添加到组合 ---</option>
                                        </select>
                                        <button onclick="addSelectedStockFromPoolToAgentPortfolio('agent1')" title="添加选中股票到组合">
                                            <i class="fas fa-level-down-alt"></i> 添加选中
                                        </button>
                                    </div>
                                    
                                    <div class="or-divider">或</div>

                                    <!-- Section for manual input -->
                                    <div class="manual-add-section">
                                        <input type="text" id="agent1AddToPortfolioInput" placeholder="手动输入代码/名称添加">
                                        <button onclick="addStockToAgentPortfolio('agent1')">
                                            <i class="fas fa-plus-circle"></i> 手动添加
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Agent Card 2: 大成 (Growth Investing) -->
                    <div class="agent-card growth-agent-card">
                        <div class="agent-profile">
                            <img src="images/male_avatar.png" alt="大成" class="agent-photo" id="agent2Photo">
                            <h2 class="agent-name" id="agent2NameDisplay">大成</h2>
                            <p class="agent-role">负责: <span id="agent2RoleDisplay">锐进先锋</span> 投资组合</p>
                        </div>
                        <div class="agent-details">
                            <h3><i class="fas fa-lightbulb"></i> 核心投资理念</h3>
                            <p id="agent2Logic" class="core-logic">
                                我专注于发掘具有颠覆性创新能力和巨大增长潜力的公司，尤其是在人工智能、区块链、基因编辑等前沿科技领域。
                                我相信技术进步是驱动未来经济增长的核心动力，并乐于承担较高风险以追求超额回报。我的分析侧重于公司的技术壁垒、市场规模、以及其商业模式的可扩展性。
                                对于量化因子，我会关注标的动能(PotScore)来捕捉市场对创新趋势的早期反应，同时分析主力资金流入情况，以验证增长故事是否获得聪明资金的认可。
                            </p>
                            
                            <div class="agent-section">
                                <h4><i class="fas fa-clipboard-list"></i> 自选股票分析池</h4>
                                <div class="stock-management">
                                    <input type="text" id="agent2StockInput" placeholder="代码 名称 (如: 300750 宁德时代)">
                                    <button onclick="addStockToPool('agent2')"><i class="fas fa-plus-circle"></i> 添加到分析池</button>
                                </div>
                                <ul id="agent2StockPoolList" class="stock-list"></ul>
                            </div>

                             <div class="agent-section analysis-section">
                                <h4><i class="fas fa-search-dollar"></i> 股票分析</h4>
                                <div class="stock-analysis-controls">
                                    <select id="agent2StockSelect" class="stock-select">
                                        <option value="">--- 从分析池选择 ---</option>
                                    </select>
                                    <span>或</span>
                                    <input type="text" id="agent2AnalysisInput" placeholder="输入新股票代码/名称分析">
                                    <button onclick="analyzeStockForAgent('agent2')"><i class="fas fa-cogs"></i> 分析股票</button>
                                </div>
                                <div class="analysis-output"> <!-- This is the parent for the textarea and button -->
                                    <h5>分析报告:</h5>
                                    <textarea id="agent2AnalysisOutput" rows="6" readonly placeholder="分析结果将在此显示..."></textarea>
                                    <!-- "View Report" button will be dynamically added here by JS -->
                                </div>
                            </div>

                            <div class="agent-section agent-portfolio-section">
                                <h4><i class="fas fa-briefcase"></i> 锐进先锋投资组合</h4>
                                <div class="agent-portfolio-controls">
                                    <button onclick="exportAgentPortfolioToExcel('agent2')"><i class="fas fa-file-excel"></i> 导出组合</button>
                                    <button onclick="openPerformanceModal('agent2')"><i class="fas fa-chart-pie"></i> 收益测算</button>
                                </div>
                                <table id="agent2PortfolioTable" class="agent-portfolio-table-style">
                                    <thead>
                                        <tr>
                                            <th>股票代码/名称</th>
                                            <th>配置比例 (%) <button class="balance-agent-portfolio-btn" data-agentid="agent2" title="自动平衡比例"><i class="fas fa-magic"></i></button></th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Agent 2 Portfolio items -->
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <td class="total-label">总计:</td>
                                            <td id="agent2PortfolioTotalAllocation" class="total-value">0%</td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                </table>
                                <div class="stock-management add-to-agent-portfolio">
                                    <!-- Section for adding from analysis pool -->
                                    <div class="add-from-pool-section">
                                        <select id="agent2AddFromPoolSelect" class="stock-select">
                                            <option value="">--- 从分析池选择添加到组合 ---</option>
                                        </select>
                                        <button onclick="addSelectedStockFromPoolToAgentPortfolio('agent2')" title="添加选中股票到组合">
                                            <i class="fas fa-level-down-alt"></i> 添加选中
                                        </button>
                                    </div>

                                    <div class="or-divider">或</div>
                                    
                                    <!-- Section for manual input -->
                                    <div class="manual-add-section">
                                        <input type="text" id="agent2AddToPortfolioInput" placeholder="手动输入代码/名称添加">
                                        <button onclick="addStockToAgentPortfolio('agent2')">
                                            <i class="fas fa-plus-circle"></i> 手动添加
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="myPortfolio" class="main-tab-content">
                <div class="my-portfolio-header">
                    <h2>
                        <i class="fas fa-briefcase"></i> 
                        <span id="myPortfolioTitleText" contenteditable="false">我的投资组合</span>
                        <button id="editMyPortfolioTitleBtn" class="edit-title-btn" title="编辑组合名称"><i class="fas fa-pencil-alt"></i></button>
                    </h2>
                    <div class="my-portfolio-controls">
                        <button onclick="syncStocksToMyPortfolio()"><i class="fas fa-sync-alt"></i> 同步AI智能体组合</button>
                        <button onclick="exportMyPortfolioToExcel()"><i class="fas fa-file-excel"></i> 导出我的组合</button>
                        <button onclick="openPerformanceModal('myPortfolio')"><i class="fas fa-chart-pie"></i> 我的组合收益测算</button>
                    </div>
                </div>
                <p class="my-portfolio-description">以下是根据AI智能体建议及您的自定义配置形成的投资组合。您可以调整各项资产的比例。</p>
                
                <table id="myPortfolioTable">
                    <thead>
                        <tr>
                            <th>股票代码/名称</th>
                            <th>来源</th>
                            <th>建议比例 (%)</th>
                            <th>我的配置 (%) <button id="balancePortfolioBtn" title="自动平衡未配置股票的比例"><i class="fas fa-magic"></i></button></th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Portfolio items will be added here -->
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3" class="total-label">总计:</td>
                            <td id="myPortfolioTotalAllocation" class="total-value">0%</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <footer>
            <p>© 2025 AI范式进化. 保留所有权利。</p>
            <p>投资有风险，入市需谨慎。本内容仅供参考，不构成任何投资建议。</p>
        </footer>
    </div>

    <!-- API Settings Modal -->
    <div id="apiSettingsModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeApiSettingsModal()">×</span>
            <h2><i class="fas fa-cog"></i> API及模型设置</h2>
            <div class="settings-form">
                <div class="form-group">
                    <label for="apiEndpointSelect"><i class="fas fa-server"></i> 模型接入点 (API Endpoint):</label>
                    <select id="apiEndpointSelect" class="stock-select">
                        <!-- Options will be populated by JS -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="apiKey"><i class="fas fa-key"></i> API Key:</label>
                    <input type="password" id="apiKey" placeholder="输入您的API Key">
                </div>
                <div class="form-group">
                    <label for="apiModelSelect"><i class="fas fa-robot"></i> 模型选择:</label>
                    <select id="apiModelSelect" class="stock-select">
                        <!-- Options will be populated by JS based on endpoint selection -->
                    </select>
                </div>
                <button onclick="saveApiSettings()"><i class="fas fa-save"></i> 保存设置</button>
                <button onclick="clearApiSettings()" class="danger-btn" style="margin-top: 10px;"><i class="fas fa-trash-alt"></i> 清除已存API信息</button>
                <p id="settingsStatus" class="status-message"></p>
            </div>
        </div>
    </div>

    <!-- Performance Backtest Modal -->
    <div id="performanceModal" class="modal">
        <div class="modal-content large">
            <span class="close-button" onclick="closePerformanceModal()">×</span>
            <h2 id="performanceModalTitle"><i class="fas fa-chart-pie"></i> 投资组合收益测算评估</h2>
            <div class="performance-controls">
                <label for="backtestStartDate">开始日期:</label>
                <input type="date" id="backtestStartDate">
                <label for="backtestEndDate">结束日期:</label>
                <input type="date" id="backtestEndDate">
                <button onclick="runBacktest()"><i class="fas fa-play-circle"></i> 开始测算</button>
            </div>
            <div id="backtestResults" class="backtest-results-area">
                <p>请选择日期范围并开始测算。注意：此功能为演示，实际回测需要历史数据和复杂计算。</p>
                <canvas id="performanceChart" style="display:none;"></canvas>
            </div>
        </div>
    </div>

    <!-- Analysis Report Modal -->
    <div id="analysisReportModal" class="modal">
        <div class="modal-content large">
            <span class="close-button" onclick="closeAnalysisReportModal()">×</span>
            <h2 id="analysisReportModalTitle"><i class="fas fa-file-alt"></i> AI分析报告</h2>
            <div class="analysis-report-modal-controls">
                <button onclick="copyAnalysisReportToClipboard()"><i class="fas fa-copy"></i> 复制报告内容</button>
            </div>
            <div id="analysisReportModalBody" class="analysis-report-body">
                <!-- Report content will be injected here by JavaScript -->
            </div>
        </div>
    </div>


    <script src="scripts/potfunddatarender.js"></script>
    <script src="scripts/portfolio_agent.js"></script>
    <script>
        // GitHub Auth Constants
        const GITHUB_CLIENT_ID = 'Ov23liAr5gYJACq7QZ1p'; // 在部署时替换为真实ID
        const REDIRECT_URI = 'https://aipeinvestmentagent.pages.dev/callback.html'; 
        const GITHUB_AUTH_SCOPE = 'read:user user:email';

        // DOM Elements for Auth 
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const githubUserInfoDiv = document.getElementById('githubUserInfo');
        const githubUserAvatarImg = document.getElementById('githubUserAvatar');
        const githubUserNameSpan = document.getElementById('githubUserName');
        const authErrorMessagesDiv = document.getElementById('authErrorMessages');
        const portfolioActionsDiv = document.querySelector('.portfolio-actions');


        let siteCoreDataReady = false; // Flag for Excel data (allStockData)

        async function initializeCoreSiteData() {
            if (siteCoreDataReady) {
                console.log("index.html initializeCoreSiteData: Core data already marked ready.");
                return;
            }
            console.log("index.html: Initializing core site data (Excel)...");
            if (typeof loadAndProcessExcelData === "function") {
                if (typeof window.allStockDataGlobalPromise === 'undefined') {
                    window.allStockDataGlobalPromise = loadAndProcessExcelData();
                }
                try {
                    await window.allStockDataGlobalPromise;
                    if (typeof allStockData !== 'undefined' && Object.keys(allStockData).length > 0) {
                        siteCoreDataReady = true;
                        console.log("index.html: Excel data (allStockData) is now ready.");
                    } else {
                        console.error("index.html: Excel data promise resolved, but `allStockData` is empty or undefined.");
                        if(authErrorMessagesDiv) authErrorMessagesDiv.textContent = "错误：股票基础数据加载不完整。";
                    }
                } catch (error) {
                    console.error("index.html: Error loading Excel data via promise:", error);
                    if(authErrorMessagesDiv) authErrorMessagesDiv.textContent = "股票基础数据加载失败。";
                    // Do not alert here, let portfolio_agent.js's ensureStockDataIsReady handle alerts if user tries an action
                }
            } else {
                console.error("index.html: loadAndProcessExcelData function not found!");
                if(authErrorMessagesDiv) authErrorMessagesDiv.textContent = "错误：无法启动数据加载流程。";
            }
        }

        function generateRandomState() { return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15); }
        
        async function fetchGitHubUserInfoFromApi(accessToken) { 
            if (authErrorMessagesDiv) authErrorMessagesDiv.textContent = ''; 
            try {
                const response = await fetch('https://api.github.com/user', { headers: { 'Authorization': `token ${accessToken}`, 'Accept': 'application/vnd.github.v3+json'} });
                if (!response.ok) { const errorData = await response.json(); throw new Error(`GitHub API error: ${errorData.message || response.statusText}`); }
                return await response.json();
            } catch (error) {
                console.error('Error fetching GitHub user info:', error);
                if (authErrorMessagesDiv) {authErrorMessagesDiv.textContent = `无法获取用户信息: ${error.message}`; authErrorMessagesDiv.style.display = 'block';}
                return null;
            }
        }

        function displayLoggedInUser(userData) {
            if (userData && githubUserAvatarImg && githubUserNameSpan && githubUserInfoDiv && loginBtn && logoutBtn) {
                githubUserAvatarImg.src = userData.avatar_url || 'images/default_avatar.png'; 
                githubUserNameSpan.textContent = userData.name || userData.login; 
                githubUserInfoDiv.classList.remove('hidden');
                loginBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
                if (authErrorMessagesDiv) authErrorMessagesDiv.style.display = 'none';
                if (portfolioActionsDiv) portfolioActionsDiv.style.display = 'flex';

                // Initialize portfolios AFTER login confirmed AND core data is ready (or attempted)
                if (typeof initializePortfoliosAfterLogin === "function") {
                    if (siteCoreDataReady || (typeof allStockData !== 'undefined' && Object.keys(allStockData).length > 0)) {
                        console.log("index.html displayLoggedInUser: Core data ready, initializing portfolios.");
                        initializePortfoliosAfterLogin();
                    } else {
                        // If core data isn't ready, initializePortfoliosAfterLogin might still proceed
                        // but functions within portfolio_agent.js (like addStockToPool) will await ensureStockDataIsReady.
                        console.warn("index.html displayLoggedInUser: Core data not marked ready, but proceeding with portfolio init.");
                        initializePortfoliosAfterLogin();
                    }
                } else { console.error("initializePortfoliosAfterLogin function not found."); }

            } else { 
                console.warn("User info UI elements missing or user data null in displayLoggedInUser."); 
                handleLogout(); 
            }
        }

        function updateAuthUI() {
            const accessToken = localStorage.getItem('github_access_token');
            const storedUserInfo = localStorage.getItem('github_user_info');
            if (authErrorMessagesDiv) authErrorMessagesDiv.textContent = '';

            const applyLoggedOutState = () => {
                if (githubUserInfoDiv && loginBtn && logoutBtn) {
                    githubUserInfoDiv.classList.add('hidden');
                    loginBtn.classList.remove('hidden');
                    logoutBtn.classList.add('hidden');
                }
                if (authErrorMessagesDiv) authErrorMessagesDiv.style.display = 'none';
                if (portfolioActionsDiv) portfolioActionsDiv.style.display = 'none';

                // Even if logged out, try to initialize portfolios (will use local/defaults)
                if (typeof initializePortfoliosAfterLogin === "function") {
                     if (siteCoreDataReady || (typeof allStockData !== 'undefined' && Object.keys(allStockData).length > 0)) {
                        console.log("index.html updateAuthUI (logged out): Core data ready, initializing portfolios.");
                        initializePortfoliosAfterLogin();
                    } else {
                        console.warn("index.html updateAuthUI (logged out): Core data not ready, portfolio init may rely on fallbacks.");
                        initializePortfoliosAfterLogin();
                    }
                }
            };
            
            const applyErrorState = (message) => {
                if (authErrorMessagesDiv) { authErrorMessagesDiv.textContent = message; authErrorMessagesDiv.style.display = 'block';}
                handleLogout(); 
            };

            if (accessToken && storedUserInfo) {
                try {
                    const userData = JSON.parse(storedUserInfo);
                    displayLoggedInUser(userData); // This will call initializePortfoliosAfterLogin
                } catch (e) {
                    console.error("Error parsing stored user info:", e);
                    applyErrorState("登录会话已损坏，请重新登录。");
                }
            } else if (accessToken && !storedUserInfo) {
                console.log("Access token found, user info missing. Fetching...");
                fetchGitHubUserInfoFromApi(accessToken).then(userData => {
                    if (userData) {
                        localStorage.setItem('github_user_info', JSON.stringify(userData));
                        displayLoggedInUser(userData); // This will call initializePortfoliosAfterLogin
                    } else {
                        applyErrorState("无法验证登录会话，请重新登录。");
                    }
                });
            }
            else { 
                applyLoggedOutState();
            }
        }

        function handleLogin() { 
             if (!GITHUB_CLIENT_ID || GITHUB_CLIENT_ID === 'YOUR_GITHUB_CLIENT_ID') {
                alert('GitHub Client ID 未在 index.html 中配置!'); return;
            }
            const state = generateRandomState();
            localStorage.setItem('oauth_state', state);
            const authUrl = `https://github.com/login/oauth/authorize?client_id=${GITHUB_CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${encodeURIComponent(GITHUB_AUTH_SCOPE)}&state=${state}`;
            window.location.href = authUrl;
        }
        function handleLogout() { 
            localStorage.removeItem('github_access_token');
            localStorage.removeItem('github_user_info');
            localStorage.removeItem('oauth_state'); 
            updateAuthUI(); // This will re-initialize portfolios for logged-out state
        }

        if (loginBtn) loginBtn.addEventListener('click', handleLogin);
        if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);
        
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("index.html: DOMContentLoaded - Starting initialization.");

            // Crucial Step 1: Load Excel data (allStockData) and wait for it.
            await initializeCoreSiteData();
            console.log("index.html: `initializeCoreSiteData` completed. `siteCoreDataReady`=", siteCoreDataReady);
            
            // Crucial Step 2: Initialize authentication UI (which will then trigger portfolio loading).
            updateAuthUI();
            console.log("index.html: `updateAuthUI` called.");

            // Other UI initializations from portfolio_agent.js (like setting up agent names, modals etc.)
            // are typically inside its own DOMContentLoaded or called by initializePortfoliosAfterLogin.
            // We just need to make sure the core data and auth state are established first.
        });
    </script>
</body>
</html>
