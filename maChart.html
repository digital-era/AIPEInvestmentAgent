<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>均线分析图表</title>
  <style>
    body {
      margin: 0;
      background-color: #181818;
      color: #eee;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }
    #container, #volumeContainer, #macdContainer, #rsiContainer {
      width: 100vw;
      height: 25vh;
    }
    #container {
      height: 35vh;
    }
    #legend {
      text-align: center;
      padding: 10px;
      color: #ccc;
      font-size: 14px;
    }
    .ma-label {
      display: inline-block;
      margin: 0 10px;
      font-weight: bold;
    }
    #infoBox {
      padding: 10px;
      color: #fff;
      font-size: 14px;
      background-color: #222;
      border-top: 1px solid #444;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <h2 style="text-align: center; color: #a0d2eb">均线分析</h2>
  <div id="legend"></div>
  <div id="container"></div>
  <div id="volumeContainer"></div>
  <div id="macdContainer"></div>
  <div id="rsiContainer"></div>
  <div id="infoBox">鼠标移动查看详情</div>

  <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
  <script>
    const stockCode = new URLSearchParams(window.location.search).get("code") || "600900";
    const stockName = new URLSearchParams(window.location.search).get("name") || "股票";
    const isUS = /^us|^US/.test(stockCode);
    const isETF = /^(58|55|51|15)/.test(stockCode);

    document.title = `均线分析 - ${stockName} (${stockCode})`;

    const container = document.getElementById('container');
    const volumeContainer = document.getElementById('volumeContainer');
    const macdContainer = document.getElementById('macdContainer');
    const rsiContainer = document.getElementById('rsiContainer');
    const legend = document.getElementById('legend');
    const infoBox = document.getElementById('infoBox');

    const chart = LightweightCharts.createChart(container, {
      layout: { background: { color: '#181818' }, textColor: '#ccc' },
      timeScale: {
        timeVisible: true,
        tickMarkFormatter: (time) => {
          const date = new Date((isUS ? time : time + 8 * 3600) * 1000);
          return `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2,'0')}-${date.getDate().toString().padStart(2,'0')}`;
        }
      },
      crosshair: { mode: 0 },
    });

    const volumeChart = LightweightCharts.createChart(volumeContainer, {
      layout: { background: { color: '#181818' }, textColor: '#ccc' },
      crosshair: { mode: 0 },
      timeScale: { visible: false }
    });

    const macdChart = LightweightCharts.createChart(macdContainer, {
      layout: { background: { color: '#181818' }, textColor: '#ccc' },
      crosshair: { mode: 0 },
      timeScale: { visible: false }
    });

    const rsiChart = LightweightCharts.createChart(rsiContainer, {
      layout: { background: { color: '#181818' }, textColor: '#ccc' },
      crosshair: { mode: 0 },
      timeScale: { visible: false }
    });

    const candleSeries = chart.addCandlestickSeries();
    const volumeSeries = volumeChart.addHistogramSeries({ color: '#26a69a', priceFormat: { type: 'volume' }, priceScaleId: '' });

    const colors = { 5: '#e67e22', 10: '#3498db', 20: '#9b59b6', 30: '#f1c40f', 60: '#2ecc71', 120: '#e74c3c', 250: '#bdc3c7' };
    const maSeriesMap = {};
    for (const [period, color] of Object.entries(colors)) {
      const series = chart.addLineSeries({ color, lineWidth: 1.5, priceLineVisible: false });
      maSeriesMap[`MA_${period}`] = series;
      const span = document.createElement('span');
      span.className = 'ma-label';
      span.style.color = color;
      span.textContent = `MA${period}`;
      legend.appendChild(span);
    }

    const macdSeries = macdChart.addHistogramSeries({ color: '#aaa', priceFormat: { type: 'price' } });
    const signalSeries = macdChart.addLineSeries({ color: '#f39c12' });
    const macdLineSeries = macdChart.addLineSeries({ color: '#2ecc71' });

    const rsiSeries = rsiChart.addLineSeries({ color: '#9b59b6' });

    fetch(`/api/rtStockQueryProxy?code=${encodeURIComponent(stockCode)}&type=movingaveragedata`)
      .then(res => res.json())
      .then(data => {
        const candleData = [], volumeData = [], maDataMap = {}, rsiData = [], macdData = [], macdSignal = [], macdLine = [];
        let prevClose;
        const closeArr = [], ema12Arr = [], ema26Arr = [];
        for (const key in maSeriesMap) maDataMap[key] = [];

        data.forEach((d, i) => {
          const time = Math.floor(new Date(d.Date).getTime() / 1000);
          const close = d.Close, open = d.Open;
          candleData.push({ time, open, high: d.High, low: d.Low, close });
          volumeData.push({ time, value: d.Volume, color: close >= open ? 'rgba(46,204,113,0.7)' : 'rgba(231,76,60,0.7)' });
          for (const key in maSeriesMap) if (d[key] != null) maDataMap[key].push({ time, value: d[key] });

          closeArr.push(close);
          if (i >= 14) {
            const slice = closeArr.slice(i - 13, i + 1);
            const avgGain = slice.filter((v, j) => j && v > slice[j - 1]).reduce((s, v, j) => s + (v - slice[j]), 0) / 14;
            const avgLoss = slice.filter((v, j) => j && v < slice[j - 1]).reduce((s, v, j) => s + (slice[j] - v), 0) / 14;
            const rs = avgLoss === 0 ? 100 : avgGain / avgLoss;
            rsiData.push({ time, value: +(100 - (100 / (1 + rs))).toFixed(2) });
          }

          // MACD
          const k = 2 / (12 + 1);
          const j = 2 / (26 + 1);
          ema12Arr.push(i === 0 ? close : close * k + ema12Arr[i - 1] * (1 - k));
          ema26Arr.push(i === 0 ? close : close * j + ema26Arr[i - 1] * (1 - j));
          const macd = ema12Arr[i] - ema26Arr[i];
          macdLine.push(macd);
          const signal = i < 9 ? macd : macd * 0.2 + macdSignal[i - 1] * 0.8;
          macdSignal.push(signal);
          macdData.push({ time, value: macd - signal });
        });

        candleSeries.setData(candleData);
        volumeSeries.setData(volumeData);
        for (const key in maSeriesMap) maSeriesMap[key].setData(maDataMap[key]);
        rsiSeries.setData(rsiData);
        macdSeries.setData(macdData);
        signalSeries.setData(macdSignal.map((v, i) => ({ time: candleData[i].time, value: v })));
        macdLineSeries.setData(macdLine.map((v, i) => ({ time: candleData[i].time, value: v })));

        chart.subscribeCrosshairMove(param => {
          if (!param.time || !param.seriesData.size) return infoBox.textContent = '鼠标移动查看详情';
          const point = candleData.find(p => p.time === param.time);
          if (!point) return;
          const prev = candleData[candleData.findIndex(p => p.time === point.time) - 1];
          const decimal = isETF ? 3 : 2;
          const chg = prev ? (point.close - prev.close).toFixed(decimal) : '--';
          const chgPct = prev ? ((point.close - prev.close) / prev.close * 100).toFixed(2) + '%' : '--';
          const amplitude = ((point.high - point.low) / point.low * 100).toFixed(2) + '%';
          const maValues = Object.entries(maSeriesMap).map(([key, s]) => {
            const p = maDataMap[key].find(p => p.time === point.time);
            return p ? `${key.replace('MA_', 'MA')}: ${p.value.toFixed(decimal)}` : '';
          }).filter(Boolean).join(' | ');
          const vol = volumeData.find(p => p.time === point.time)?.value || 0;
          infoBox.innerHTML = `时间: ${new Date((isUS ? point.time : point.time + 8 * 3600) * 1000).toLocaleDateString()} | 开: ${point.open.toFixed(decimal)} 高: ${point.high.toFixed(decimal)} 低: ${point.low.toFixed(decimal)} 收: ${point.close.toFixed(decimal)} | 涨跌: ${chg} (${chgPct}) | 振幅: ${amplitude} | 成交量: ${vol} | ${maValues}`;
        });
      })
      .catch(e => {
        alert('图表加载失败: ' + e.message);
        console.error(e);
      });
  </script>
</body>
</html>
