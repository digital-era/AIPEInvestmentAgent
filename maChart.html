<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>均线分析（换库版）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html,body{margin:0;padding:0;height:100%;background:#181818;color:#EAEAEA;font-family:'Segoe UI','Microsoft YaHei',sans-serif;}
    header{padding:20px;text-align:center;font-size:1.8rem;color:#a0d2eb;border-bottom:1px solid #333;}
    #chartContainer{position:absolute;top:60px;bottom:0;left:0;right:0;}
    #chart{width:100%;height:100%;}
    #loading{position:absolute;top:50%;width:100%;text-align:center;color:#888;}
  </style>
</head>
<body>
  <header id="chartTitle">均线分析</header>
  <div id="chartContainer">
    <div id="chart"></div>
    <div id="loading">加载中...</div>
  </div>

  <!-- Lightweight Charts 库 -->
  <script src="https://unpkg.com/lightweight-charts@4.5.0/dist/lightweight-charts.standalone.production.js"></script>
  <script>
  (async ()=>{
    function getParam(name){
      return (new URLSearchParams(location.search)).get(name)||'';
    }

    const code = getParam('code');
    const name = getParam('name') || code;
    if(!code){ alert('缺少code'); return; }

    document.getElementById('chartTitle').innerText = `均线分析: ${name} (${code})`;

    // 初始化图表
    const chart = LightweightCharts.createChart(document.getElementById('chart'), {
      layout:{background:'#181818',textColor:'#EAEAEA'},
      grid:{vertLines:{color:'#333'},horzLines:{color:'#333'}},
      rightPriceScale:{scaleMargins:{top:0.3,bottom:0.2}},
      timeScale:{borderColor:'#333'}
    });

    const candleSeries = chart.addCandlestickSeries();
    const volumeSeries = chart.addHistogramSeries({scaleMargins:{top:0.7,bottom:0},color:'#26a69a'});
    const ma5 = chart.addLineSeries({color:'#e67e22',lineWidth:2});
    const ma10 = chart.addLineSeries({color:'#3498db',lineWidth:2});
    const ma20 = chart.addLineSeries({color:'#9b59b6',lineWidth:2});

    try {
      const res = await fetch(`/api/rtStockQueryProxy?code=${encodeURIComponent(code)}&type=movingaveragedata`);
      if(!res.ok) throw new Error(res.status);
      const data = await res.json();
      if(!Array.isArray(data)||!data.length) throw new Error('无数据');

      const candleData = data.map(d=>({
        time: d.Date,
        open: d.Open, high:d.High, low:d.Low, close:d.Close
      }));
      candleSeries.setData(candleData);

      volumeSeries.setData(data.map(d=>({
        time:d.Date,
        value:d.Volume,
        color:d.Close>=d.Open?'#26a69a':'#ee6666'
      })));

      const calcMA = (period) => candleData.map((_,i,arr)=>i>=period-1 ? {
        time:arr[i].time, value: arr.slice(i-period+1,i+1).reduce((s, v)=>s+v.close,0)/period
      } : null).filter(x=>x);

      ma5.setData(calcMA(5));
      ma10.setData(calcMA(10));
      ma20.setData(calcMA(20));

      document.getElementById('loading').style.display = 'none';
    } catch(e){
      document.getElementById('loading').innerText = '加载失败: '+e.message;
      console.error(e);
    }
  })();
  </script>
</body>
</html>
