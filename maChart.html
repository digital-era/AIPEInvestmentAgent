<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>均线分析</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #181818;
      color: #eaeaea;
      font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
      height: 100%;
    }
    #chart {
      height: 80vh;
    }
    #info {
      background: #222;
      color: #eee;
      padding: 10px;
      font-size: 14px;
      font-family: monospace;
    }
  </style>
  <script type="module">
    import { createChart } from 'https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.1/dist/lightweight-charts.esm.production.js';

    const chart = createChart(document.body, {
      width: window.innerWidth,
      height: window.innerHeight * 0.8,
      layout: {
        background: { color: '#181818' },
        textColor: '#eaeaea',
      },
      timeScale: {
        timeVisible: true,
        secondsVisible: false,
        tickMarkFormatter: (time) => {
          const date = new Date(time * 1000);
          return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        },
      },
      grid: {
        vertLines: { color: '#333' },
        horzLines: { color: '#333' },
      },
    });

    const candleSeries = chart.addCandlestickSeries();
    const volumeSeries = chart.addHistogramSeries({
      color: '#26a69a',
      priceFormat: { type: 'volume' },
      priceScaleId: '',
      scaleMargins: { top: 0.8, bottom: 0 },
    });

    const maColors = ['#f39c12', '#3498db', '#9b59b6', '#f1c40f', '#2ecc71', '#e74c3c', '#bdc3c7'];
    const maPeriods = [5, 10, 20, 30, 60, 120, 250];
    const maSeries = maPeriods.map((_, i) => chart.addLineSeries({ color: maColors[i], lineWidth: 1.5 }));

    const macdLine = chart.addLineSeries({ color: '#00bcd4', lineWidth: 1 });
    const signalLine = chart.addLineSeries({ color: '#e91e63', lineWidth: 1 });
    const histogram = chart.addHistogramSeries({ color: '#888', scaleMargins: { top: 0.85, bottom: 0 } });

    const infoDiv = document.createElement('div');
    infoDiv.id = 'info';
    document.body.appendChild(infoDiv);

    async function fetchData() {
      const params = new URLSearchParams(location.search);
      const code = params.get('code');
      const name = params.get('name') || code;
      const url = `/api/rtStockQueryProxy?code=${encodeURIComponent(code)}&type=movingaveragedata`;

      const res = await fetch(url);
      const data = await res.json();

      const candles = [],
            volume = [],
            macdArr = [],
            signalArr = [],
            histArr = [];

      const maValues = maPeriods.map(() => []);

      for (const d of data) {
        const ts = Math.floor(new Date(d.Date).getTime() / 1000);
        candles.push({
          time: ts,
          open: d.Open,
          high: d.High,
          low: d.Low,
          close: d.Close,
        });

        volume.push({ time: ts, value: d.Volume, color: d.Close >= d.Open ? '#26a69a' : '#ef5350' });

        maPeriods.forEach((p, i) => {
          if (d[`MA_${p}`] != null) {
            maValues[i].push({ time: ts, value: d[`MA_${p}`] });
          }
        });

        if (d.MACD != null && d.MACDSignal != null && d.MACDHist != null) {
          macdArr.push({ time: ts, value: d.MACD });
          signalArr.push({ time: ts, value: d.MACDSignal });
          histArr.push({ time: ts, value: d.MACDHist, color: d.MACDHist >= 0 ? '#00ff00' : '#ff4444' });
        }
      }

      candleSeries.setData(candles);
      volumeSeries.setData(volume);
      macdLine.setData(macdArr);
      signalLine.setData(signalArr);
      histogram.setData(histArr);
      maValues.forEach((ma, i) => maSeries[i].setData(ma));

      chart.subscribeCrosshairMove(param => {
        if (!param.time || !param.seriesData) return;
        const d = new Date(param.time * 1000);
        const fmt = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        const candle = param.seriesData.get(candleSeries);
        if (!candle) return;

        const change = (candle.close - candle.open).toFixed(2);
        const changePct = ((change / candle.open) * 100).toFixed(2);
        const amplitude = ((candle.high - candle.low) / candle.open * 100).toFixed(2);

        let maText = maSeries.map((s, i) => {
          const v = param.seriesData.get(s);
          return v ? `MA${maPeriods[i]}: ${v.value.toFixed(2)}` : '';
        }).filter(Boolean).join(' | ');

        infoDiv.innerText = [
          `日期: ${fmt}`,
          `开: ${candle.open.toFixed(2)} 高: ${candle.high.toFixed(2)} 低: ${candle.low.toFixed(2)} 收: ${candle.close.toFixed(2)}`,
          `涨跌: ${change} (${changePct}%) 振幅: ${amplitude}%`,
          `成交量: ${param.seriesData.get(volumeSeries)?.value ?? '--'}`,
          maText
        ].join('  \n');
      });
    }

    fetchData();
  </script>
</head>
<body>
</body>
</html>
