<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>均线分析</title>

  <!-- Chart.js v4 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Luxon 时间支持 -->
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"></script>
  <!-- 金融图插件 v1 兼容 Chart.js v4 -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@1.0.0-beta.15/dist/chartjs-chart-financial.umd.js"></script>

  <style>
    html, body {
      margin: 0; padding: 0; height: 100%;
      background: #181818;
      color: #EAEAEA;
      font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
      display: flex;
      flex-direction: column;
    }
    header {
      padding: 20px;
      border-bottom: 1px solid #3A3A3A;
      text-align: center;
      font-size: 2rem;
      color: #a0d2eb;
    }
    #chartContainer {
      flex: 1;
      padding: 20px;
    }
    canvas {
      width: 100%;
      height: 100%;
    }
    #loading {
      text-align: center;
      font-size: 1.3rem;
      color: #aaa;
      margin-top: 50px;
    }
  </style>
</head>
<body>
  <header id="chartTitle">均线分析</header>
  <div id="chartContainer">
    <canvas id="popupMaChart"></canvas>
    <div id="loading">正在加载数据...</div>
  </div>

<script>
(async function () {
  const { Chart } = window;

  // 注册所有必要组件（必须明确注册）
  Chart.register(
    window.FinancialController,
    window.CandlestickController,
    window.CandlestickElement,
    window.FinancialScale,
    window.TimeScale,
    window.LinearScale,
    window.BarController,
    window.BarElement,
    window.Tooltip,
    window.Legend,
    window['chartjs-adapter-luxon']
  );

  const stockCode = new URLSearchParams(location.search).get('code') || '';
  const stockName = new URLSearchParams(location.search).get('name') || stockCode;

  const titleEl = document.getElementById('chartTitle');
  const canvas = document.getElementById('popupMaChart');
  const ctx = canvas.getContext('2d');
  const loadingEl = document.getElementById('loading');

  titleEl.textContent = `均线分析: ${stockName} (${stockCode})`;
  document.title = `均线分析 - ${stockName} (${stockCode})`;

  try {
    const res = await fetch(`/api/rtStockQueryProxy?code=${encodeURIComponent(stockCode)}&type=movingaveragedata`);
    if (!res.ok) throw new Error(`API 请求失败: ${res.status}`);
    const data = await res.json();
    if (!Array.isArray(data) || data.length === 0) throw new Error('数据为空');

    const luxon = window.luxon;

    const candlestickData = data.map(d => ({
      x: luxon.DateTime.fromISO(d.Date).toMillis(),
      o: d.Open,
      h: d.High,
      l: d.Low,
      c: d.Close
    }));

    const volumeData = data.map(d => ({
      x: luxon.DateTime.fromISO(d.Date).toMillis(),
      y: d.Volume
    }));

    const volumeColors = data.map(d => d.Close >= d.Open ? 'rgba(46, 204, 113, 0.7)' : 'rgba(231, 76, 60, 0.7)');

    const maConfigs = [
      { period: 5, color: '#e67e22' },
      { period: 10, color: '#3498db' },
      { period: 20, color: '#9b59b6' },
      { period: 30, color: '#f1c40f' },
      { period: 60, color: '#2ecc71' },
      { period: 120, color: '#e74c3c' },
      { period: 250, color: '#bdc3c7' }
    ];

    const maDatasets = maConfigs.flatMap(cfg => {
      const key = 'MA_' + cfg.period;
      if (!data.some(d => d[key] != null)) return [];
      return {
        type: 'line',
        label: 'MA' + cfg.period,
        data: data.map(d => ({
          x: luxon.DateTime.fromISO(d.Date).toMillis(),
          y: d[key]
        })).filter(p => p.y != null),
        borderColor: cfg.color,
        borderWidth: 1.5,
        pointRadius: 0,
        yAxisID: 'y'
      };
    });

    loadingEl.style.display = 'none';
    canvas.style.display = 'block';

    new Chart(ctx, {
      type: 'bar',
      data: {
        datasets: [
          {
            type: 'candlestick',
            label: 'K线',
            data: candlestickData,
            yAxisID: 'y'
          },
          ...maDatasets,
          {
            type: 'bar',
            label: '成交量',
            data: volumeData,
            backgroundColor: volumeColors,
            yAxisID: 'yVolume'
          }
        ]
      },
      options: {
        maintainAspectRatio: false,
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: {
            labels: { color: '#EAEAEA' }
          },
          tooltip: {
            backgroundColor: 'rgba(40,40,40,0.95)',
            titleColor: '#B0BEC5',
            bodyColor: '#EAEAEA',
            callbacks: {
              label(ctx) {
                const raw = ctx.raw;
                const label = ctx.dataset.label || '';
                if (ctx.dataset.type === 'bar') {
                  const val = raw.y;
                  return label + ': ' + (val >= 1e8 ? (val/1e8).toFixed(2) + '亿' : (val >= 1e4 ? (val/1e4).toFixed(2) + '万' : val));
                }
                if (raw && raw.c != null) {
                  return `开:${raw.o} 高:${raw.h} 低:${raw.l} 收:${raw.c}`;
                }
                return label + ': ' + ctx.formattedValue;
              }
            }
          }
        },
        scales: {
          x: {
            type: 'time',
            time: { unit: 'day', tooltipFormat: 'yyyy-MM-dd' },
            ticks: { color: '#90A4AE' },
            grid: { drawOnChartArea: false }
          },
          y: {
            position: 'left',
            ticks: { color: '#90A4AE' },
            grid: { color: 'rgba(255,255,255,0.1)' }
          },
          yVolume: {
            position: 'right',
            grid: { drawOnChartArea: false },
            ticks: {
              color: '#90A4AE',
              callback(val) {
                return val >= 1e8 ? (val / 1e8).toFixed(0) + '亿' :
                       val >= 1e4 ? (val / 1e4).toFixed(0) + '万' : val;
              }
            }
          }
        }
      }
    });

  } catch (e) {
    console.error('图表渲染失败:', e);
    loadingEl.textContent = '图表渲染失败: ' + e.message;
  }
})();
</script>
</body>
</html>
