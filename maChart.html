<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>均线分析图表</title>
  <style>
    body {
      margin: 0;
      background-color: #181818;
      color: #eee;
      font-family: 'Segoe UI', sans-serif;
    }
    #chartContainer, #macdContainer, #rsiContainer {
      width: 100vw;
      height: 30vh;
    }
    #legend {
      text-align: center;
      padding: 10px;
      color: #ccc;
      font-size: 14px;
    }
    .ma-label {
      display: inline-block;
      margin: 0 10px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h2 style="text-align: center; color: #a0d2eb">均线分析</h2>
  <div id="legend"></div>
  <div id="chartContainer"></div>
  <div id="macdContainer"></div>
  <div id="rsiContainer"></div>

  <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
  <script>
    const stockCode = new URLSearchParams(window.location.search).get("code") || "600900";
    const stockName = new URLSearchParams(window.location.search).get("name") || "股票";
    const isETF = /^(58|55|51|15)/.test(stockCode);
    const decimalPlaces = isETF ? 3 : 2;

    const chart = LightweightCharts.createChart(document.getElementById('chartContainer'), {
      layout: { background: { color: '#181818' }, textColor: '#ccc' },
      timeScale: {
        timeVisible: true,
        secondsVisible: false,
        tickMarkFormatter: t => new Date(t * 1000).toISOString().slice(0, 10)
      },
      crosshair: { mode: 0 },
      rightPriceScale: { borderColor: '#666' },
      grid: { vertLines: { color: '#444' }, horzLines: { color: '#444' } },
    });

    const macdChart = LightweightCharts.createChart(document.getElementById('macdContainer'), {
      layout: { background: { color: '#181818' }, textColor: '#ccc' },
      rightPriceScale: { borderColor: '#666' },
      timeScale: { visible: false },
      grid: { vertLines: { color: '#444' }, horzLines: { color: '#444' } },
    });

    const rsiChart = LightweightCharts.createChart(document.getElementById('rsiContainer'), {
      layout: { background: { color: '#181818' }, textColor: '#ccc' },
      rightPriceScale: { borderColor: '#666' },
      timeScale: {
        timeVisible: true,
        tickMarkFormatter: t => new Date(t * 1000).toISOString().slice(0, 10)
      },
      grid: { vertLines: { color: '#444' }, horzLines: { color: '#444' } },
    });

    const candleSeries = chart.addCandlestickSeries();
    const macdSeries = macdChart.addHistogramSeries({ color: '#26a69a' });
    const signalLine = macdChart.addLineSeries({ color: '#e67e22' });
    const macdLine = macdChart.addLineSeries({ color: '#3498db' });
    const rsiLine = rsiChart.addLineSeries({ color: '#f1c40f' });

    const colors = {
      5: '#e67e22', 10: '#3498db', 20: '#9b59b6',
      30: '#f1c40f', 60: '#2ecc71', 120: '#e74c3c', 250: '#bdc3c7'
    };

    const maSeriesMap = {};
    for (const [period, color] of Object.entries(colors)) {
      const series = chart.addLineSeries({ color, lineWidth: 1.5, priceLineVisible: false });
      maSeriesMap[`MA_${period}`] = series;

      const span = document.createElement('span');
      span.className = 'ma-label';
      span.style.color = color;
      span.textContent = `MA${period}`;
      document.getElementById('legend').appendChild(span);
    }

    function ema(data, period) {
      const alpha = 2 / (period + 1);
      let emaArray = [];
      data.forEach((d, i) => {
        if (i === 0) emaArray.push(d);
        else emaArray.push(alpha * d + (1 - alpha) * emaArray[i - 1]);
      });
      return emaArray;
    }

    function computeMACD(close) {
      const ema12 = ema(close, 12);
      const ema26 = ema(close, 26);
      const macd = ema12.map((val, i) => val - ema26[i]);
      const signal = ema(macd, 9);
      const histogram = macd.map((val, i) => val - signal[i]);
      return { macd, signal, histogram };
    }

    function computeRSI(close, period = 14) {
      let rsi = [];
      for (let i = period; i < close.length; i++) {
        let gains = 0, losses = 0;
        for (let j = i - period; j < i; j++) {
          const diff = close[j + 1] - close[j];
          if (diff >= 0) gains += diff;
          else losses -= diff;
        }
        const rs = gains / (losses || 1);
        rsi.push(100 - 100 / (1 + rs));
      }
      return Array(period).fill(null).concat(rsi);
    }

    fetch(`/api/rtStockQueryProxy?code=${encodeURIComponent(stockCode)}&type=movingaveragedata`)
      .then(res => res.json())
      .then(data => {
        const candleData = [], close = [], maMap = {}, macdHist = [], signalArr = [], macdArr = [], rsiArr = [];

        for (const [key] of Object.entries(maSeriesMap)) maMap[key] = [];

        data.forEach((d, i) => {
          const time = Math.floor(new Date(d.Date).getTime() / 1000);

          candleData.push({ time, open: d.Open, high: d.High, low: d.Low, close: d.Close });
          close.push(d.Close);

          for (const key of Object.keys(maMap)) {
            maMap[key].push({ time, value: d[key] });
          }
        });

        const { macd, signal, histogram } = computeMACD(close);
        macd.forEach((val, i) => {
          const t = candleData[i]?.time;
          if (t) {
            macdArr.push({ time: t, value: val });
            signalArr.push({ time: t, value: signal[i] });
            macdHist.push({ time: t, value: histogram[i], color: histogram[i] >= 0 ? '#26a69a' : '#ef5350' });
          }
        });

        const rsi = computeRSI(close);
        rsi.forEach((val, i) => {
          const t = candleData[i]?.time;
          if (t && val != null) rsiArr.push({ time: t, value: val });
        });

        candleSeries.setData(candleData);
        for (const [key, series] of Object.entries(maSeriesMap)) series.setData(maMap[key]);

        macdSeries.setData(macdHist);
        macdLine.setData(macdArr);
        signalLine.setData(signalArr);
        rsiLine.setData(rsiArr);
      })
      .catch(e => {
        alert('图表加载失败: ' + e.message);
        console.error(e);
      });
  </script>
</body>
</html>
