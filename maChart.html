<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>均线分析图表</title>
  <style>
    body { margin: 0; background-color: #181818; color: #eee; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; }
    #controls { text-align: center; padding: 10px 0; }
    .mode-btn { background-color: #333; color: #ccc; border: 1px solid #555; padding: 6px 12px; margin: 0 5px; border-radius: 4px; cursor: pointer; font-size: 14px; }
    .mode-btn.active { background-color: #007bff; color: white; border-color: #007bff; }
    #legend { text-align: center; padding: 10px; color: #ccc; font-size: 14px; }
    .ma-label { display: inline-block; margin: 0 8px; font-weight: bold; }
    #container, #volumeContainer, #macdContainer, #rsiContainer { width: 100vw; }
    #container { height: 55vh; }
    #volumeContainer, #macdContainer, #rsiContainer { height: 15vh; }
    #tooltip { text-align: center; font-size: 14px; color: #eee; background-color: #222; padding: 8px; }
  </style>
</head>
<body>
  <h2 style="text-align: center; color: #a0d2eb">均线分析</h2>
  <div id="controls">
    <button id="dailyBtn" class="mode-btn active">日K</button>
    <button id="intradayBtn" class="mode-btn">分时</button>
  </div>
  <div id="legend"></div>
  <div id="tooltip">鼠标移动查看详情</div>
  <div id="container"></div>
  <div id="volumeContainer"></div>
  <div id="macdContainer"></div>
  <div id="rsiContainer"></div>
  
  <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
  
  <script>
    const params = new URLSearchParams(window.location.search);
    const stockCode = params.get("code") || "600900";
    const stockName = params.get("name") || "股票";
    const isETF = /^(58|55|51|15)/.test(stockCode);
    const isUSStock = /^us|^US/.test(stockCode);
    const decimalPlaces = isETF ? 3 : 2;

    document.title = `均线分析 - ${stockName} (${stockCode})`;

    let currentMode = 'daily';
    let lastDayMAs = {};
    let crosshairSubscriber = null;

    const createChart = (containerId, options = {}) => { /* ... (此函数无变化) ... */ };
    const mainChart = LightweightCharts.createChart(document.getElementById('container'), { layout: { background: { color: '#181818' }, textColor: '#ccc' }, grid: { vertLines: { color: '#333' }, horzLines: { color: '#333' } }, crosshair: { mode: LightweightCharts.CrosshairMode.Normal }, timeScale: { borderColor: '#666' }, rightPriceScale: { borderColor: '#666' } });
    const volumeChart = LightweightCharts.createChart(document.getElementById('volumeContainer'), { layout: { background: { color: '#181818' }, textColor: '#ccc' }, grid: { vertLines: { color: '#333' }, horzLines: { color: '#333' } }, crosshair: { mode: LightweightCharts.CrosshairMode.Normal }, timeScale: { visible: false }, rightPriceScale: { borderColor: '#666' } });
    const macdChart = LightweightCharts.createChart(document.getElementById('macdContainer'), { layout: { background: { color: '#181818' }, textColor: '#ccc' }, grid: { vertLines: { color: '#333' }, horzLines: { color: '#333' } }, crosshair: { mode: LightweightCharts.CrosshairMode.Normal }, timeScale: { visible: false }, rightPriceScale: { borderColor: '#666' } });
    const rsiChart = LightweightCharts.createChart(document.getElementById('rsiContainer'), { layout: { background: { color: '#181818' }, textColor: '#ccc' }, grid: { vertLines: { color: '#333' }, horzLines: { color: '#333' } }, crosshair: { mode: LightweightCharts.CrosshairMode.Normal }, timeScale: { visible: false }, rightPriceScale: { borderColor: '#666' } });
    
    mainChart.timeScale().subscribeVisibleLogicalRangeChange(range => { [volumeChart, macdChart, rsiChart].forEach(c => c.timeScale().setVisibleLogicalRange(range)); });

    let candleSeries, volumeSeries, macdHistogram, macdDIF, macdDEA, rsiLine;
    let intradayPriceSeries, intradayAvgPriceSeries;
    const maSeriesMap = {};

    function clearAllSeries() { /* ... (此函数无变化) ... */ }
    const formatDate = (timestamp, format = 'YYYY-MM-DD') => { /* ... (此函数无变化) ... */ };

    // --- 日K图渲染逻辑 (已修复) ---
    async function renderDailyChart() {
        clearAllSeries();
        document.getElementById('macdContainer').style.display = 'block';
        document.getElementById('rsiContainer').style.display = 'block';
        mainChart.applyOptions({ localization: { dateFormat: 'yyyy-MM-dd' }, timeScale: { tickMarkFormatter: time => formatDate(time, 'YYYY-MM-DD') } });

        candleSeries = mainChart.addCandlestickSeries();
        volumeSeries = volumeChart.addHistogramSeries({ priceFormat: { type: 'volume' }});
        macdHistogram = macdChart.addHistogramSeries();
        macdDIF = macdChart.addLineSeries({ color: '#3498db' });
        macdDEA = macdChart.addLineSeries({ color: '#ffa500' });
        rsiLine = rsiChart.addLineSeries({ color: '#1abc9c' });
        const colors = { 5: '#e67e22', 10: '#3498db', 20: '#9b59b6', 30: '#f1c40f', 60: '#2ecc71', 120: '#e74c3c', 250: '#bdc3c7' };
        for (const [period, color] of Object.entries(colors)) {
            maSeriesMap[`MA_${period}`] = mainChart.addLineSeries({ color, lineWidth: 1.5, priceLineVisible: false });
            const span = document.createElement('span');
            span.className = 'ma-label';
            span.style.color = color;
            span.setAttribute('data-key', `MA_${period}`);
            span.innerText = `MA${period}`;
            document.getElementById('legend').appendChild(span);
        }

        try {
            const res = await fetch(`/api/rtStockQueryProxy?code=${encodeURIComponent(stockCode)}&type=movingaveragedata`);
            
            // ==========================================================
            // >>>>>>>>>>>>>>>>>>>>>>>>> 新增的修复代码 <<<<<<<<<<<<<<<<<<<
            // ==========================================================
            if (!res.ok) {
                // 如果API返回错误（如404, 500等），则构造一个错误并抛出
                const errorInfo = await res.json().catch(() => ({ detail: res.statusText }));
                throw new Error(`API返回错误 ${res.status}: ${errorInfo.detail || '未知错误'}`);
            }
            // ==========================================================

            const data = await res.json();
            // 如果成功，但数据为空数组，也进行提示
            if (!Array.isArray(data) || data.length === 0) {
                throw new Error("API返回的数据为空或格式不正确。");
            }

            const adjustTime = utcStr => { /* ... */ };
            const candleData = [], volumeData = [], rsiData = [], difData = [], deaData = [], macdData = [];
            const maDataMap = {};
            for (const key of Object.keys(maSeriesMap)) maDataMap[key] = [];

            // 这里的 data.map 现在是安全的
            const closes = data.map(d => d.Close);
            const ema = (arr, period) => { /* ... */ };
            const rsi = (values, period = 14) => { /* ... */ };
            const ema12 = ema(closes, 12), ema26 = ema(closes, 26);
            const dif = ema12.map((v, i) => v - ema26[i]);
            const dea = ema(dif.slice(1), 9);
            const macd = dif.map((v, i) => i < dea.length ? v - dea[i - 1] : null);
            const rsiValues = rsi(closes);

            data.forEach((d, i) => { /* ... */ });
            
            const lastDataPoint = data[data.length - 1];
            for (const key of Object.keys(maSeriesMap)) { lastDayMAs[key] = lastDataPoint[key]; }

            candleSeries.setData(candleData);
            volumeSeries.setData(volumeData);
            for (const [key, series] of Object.entries(maSeriesMap)) series.setData(maDataMap[key]);
            macdHistogram.setData(macdData);
            macdDIF.setData(difData);
            macdDEA.setData(deaData);
            rsiLine.setData(rsiData);
            
            crosshairSubscriber = mainChart.subscribeCrosshairMove(param => { /* ... */ });
            document.getElementById('intradayBtn').disabled = false;
        } catch (error) {
            console.error("加载日K数据失败:", error);
            document.getElementById('tooltip').innerText = "加载日K数据失败，可能是非交易日或代码无效。";
        }
    }
    
    // --- 分时图渲染逻辑 (已修复) ---
    async function renderIntradayChart() {
        if (Object.keys(lastDayMAs).length === 0) { alert("日K数据尚未加载完成，无法切换。"); return; }
        clearAllSeries();
        document.getElementById('macdContainer').style.display = 'none';
        document.getElementById('rsiContainer').style.display = 'none';
        mainChart.applyOptions({ localization: { timeFormatter: time => formatDate(time, 'HH:mm') }, timeScale: { tickMarkFormatter: time => formatDate(time, 'HH:mm') } });

        intradayPriceSeries = mainChart.addAreaSeries({ lineColor: '#4e8df5', topColor: 'rgba(78, 141, 245, 0.4)', bottomColor: 'rgba(78, 141, 245, 0)' });
        intradayAvgPriceSeries = mainChart.addLineSeries({ color: '#f1c40f', lineWidth: 1 });
        volumeSeries = volumeChart.addHistogramSeries({ priceFormat: { type: 'volume' } });
        const colors = { 5: '#e67e22', 10: '#3498db', 20: '#9b59b6', 30: '#f1c40f', 60: '#2ecc71', 120: '#e74c3c', 250: '#bdc3c7' };
        for (const [period, color] of Object.entries(colors)) {
            if(lastDayMAs[`MA_${period}`]){
                maSeriesMap[`MA_${period}`] = mainChart.addLineSeries({ color, lineWidth: 1.5, priceLineVisible: false, lineStyle: LightweightCharts.LineStyle.Dashed });
                const span = document.createElement('span');
                span.className = 'ma-label';
                span.style.color = color;
                span.innerText = `MA${period}:${lastDayMAs[`MA_${period}`].toFixed(decimalPlaces)}`;
                document.getElementById('legend').appendChild(span);
            }
        }
        
        try {
            const res = await fetch(`/api/rtStockQueryProxy?code=${encodeURIComponent(stockCode)}&type=intraday`);
            
            // ==========================================================
            // >>>>>>>>>>>>>>>>>>>>>>>>> 新增的修复代码 <<<<<<<<<<<<<<<<<<<
            // ==========================================================
            if (!res.ok) {
                const errorInfo = await res.json().catch(() => ({ detail: res.statusText }));
                throw new Error(`API返回错误 ${res.status}: ${errorInfo.detail || '未知错误'}`);
            }
            // ==========================================================

            const data = await res.json();
            if (!Array.isArray(data) || data.length === 0) {
                throw new Error("API返回的分时数据为空。");
            }

            const today = new Date().toISOString().slice(0, 10);
            const intradayData = [], avgPriceData = [], volumeData = [];
            const maDataMap = {};
            for (const key of Object.keys(maSeriesMap)) maDataMap[key] = [];

            data.forEach((d, i) => { /* ... */ });

            intradayPriceSeries.setData(intradayData);
            intradayAvgPriceSeries.setData(avgPriceData);
            volumeSeries.setData(volumeData);
            for (const [key, series] of Object.entries(maSeriesMap)) series.setData(maDataMap[key]);
            
            crosshairSubscriber = mainChart.subscribeCrosshairMove(param => { /* ... */ });

        } catch (error) {
            console.error("加载分时数据失败:", error);
            document.getElementById('tooltip').innerText = "加载分时数据失败，可能是非交易日或API问题。";
        }
    }
    
    // --- 事件绑定 ---
    const dailyBtn = document.getElementById('dailyBtn');
    const intradayBtn = document.getElementById('intradayBtn');
    dailyBtn.addEventListener('click', () => { if (currentMode !== 'daily') { currentMode = 'daily'; dailyBtn.classList.add('active'); intradayBtn.classList.remove('active'); renderDailyChart(); } });
    intradayBtn.addEventListener('click', () => { if (currentMode !== 'intraday') { currentMode = 'intraday'; intradayBtn.classList.add('active'); dailyBtn.classList.remove('active'); renderIntradayChart(); } });

    // --- 初始加载 ---
    intradayBtn.disabled = true;
    renderDailyChart();

  </script>
</body>
</html>
