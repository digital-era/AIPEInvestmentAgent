<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>均线分析</title>

<!-- 引入 Lightweight Charts -->
<script src="https://unpkg.com/lightweight-charts@4.5.0/dist/lightweight-charts.standalone.production.js" defer></script>

<style>
  html, body {
    margin: 0; padding: 0; height: 100%;
    background: #181818;
    color: #EAEAEA;
    font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
    display: flex;
    flex-direction: column;
  }
  header {
    padding: 20px;
    border-bottom: 1px solid #3A3A3A;
    text-align: center;
    font-size: 2rem;
    color: #a0d2eb;
    user-select: none;
  }
  #chartContainer {
    flex: 1;
    padding: 10px 20px 20px 20px;
    position: relative;
  }
  #chart {
    width: 100%;
    height: 100%;
  }
  #loading {
    position: absolute;
    top: 40%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #bbb;
    font-size: 1.5rem;
  }
  #error {
    color: #e74c3c;
    text-align: center;
    margin-top: 20px;
  }
</style>
</head>
<body>
<header id="chartTitle">均线分析</header>
<div id="chartContainer">
  <div id="chart"></div>
  <div id="loading">正在加载数据...</div>
  <div id="error" style="display:none;"></div>
</div>

<script defer>
window.addEventListener('DOMContentLoaded', () => {
  (async () => {
    const chartTitleEl = document.getElementById('chartTitle');
    const loadingEl = document.getElementById('loading');
    const errorEl = document.getElementById('error');
    const chartContainer = document.getElementById('chart');

    function getQueryParam(name) {
      return new URLSearchParams(window.location.search).get(name) || '';
    }

    const stockCode = getQueryParam('code');
    const stockName = getQueryParam('name') || stockCode;

    if (!stockCode) {
      errorEl.style.display = 'block';
      errorEl.textContent = '缺少股票代码参数！';
      loadingEl.style.display = 'none';
      return;
    }

    chartTitleEl.textContent = `均线分析: ${stockName} (${stockCode})`;
    document.title = `均线分析 - ${stockName} (${stockCode})`;

    try {
      const resp = await fetch(`/api/rtStockQueryProxy?code=${encodeURIComponent(stockCode)}&type=movingaveragedata`);
      if (!resp.ok) throw new Error(`请求失败，状态码：${resp.status}`);
      const data = await resp.json();

      if (!Array.isArray(data) || data.length === 0) {
        throw new Error('接口未返回有效数据');
      }

      loadingEl.style.display = 'none';

      // 创建图表
      const chart = LightweightCharts.createChart(chartContainer, {
        layout: {
          backgroundColor: '#181818',
          textColor: '#EAEAEA',
        },
        grid: {
          vertLines: { color: '#333' },
          horzLines: { color: '#333' },
        },
        rightPriceScale: {
          borderColor: '#555',
        },
        timeScale: {
          borderColor: '#555',
          timeVisible: true,
          secondsVisible: false,
        },
        crosshair: {
          mode: LightweightCharts.CrosshairMode.Normal,
        },
      });

      // 添加K线序列
      const candleSeries = chart.addCandlestickSeries({
        upColor: '#26a69a',
        downColor: '#ef5350',
        borderDownColor: '#ef5350',
        borderUpColor: '#26a69a',
        wickDownColor: '#ef5350',
        wickUpColor: '#26a69a',
      });

      // 处理K线数据
      const klineData = data.map(d => ({
        time: d.Date,
        open: d.Open,
        high: d.High,
        low: d.Low,
        close: d.Close,
      }));
      candleSeries.setData(klineData);

      // 配置均线颜色和周期
      const maConfigs = [
        { period: 5, color: '#e67e22' },
        { period: 10, color: '#3498db' },
        { period: 20, color: '#9b59b6' },
        { period: 30, color: '#f1c40f' },
        { period: 60, color: '#2ecc71' },
        { period: 120, color: '#e74c3c' },
        { period: 250, color: '#bdc3c7' },
      ];

      // 添加均线序列
      for (const { period, color } of maConfigs) {
        const key = 'MA_' + period;
        if (data.some(d => d[key] != null)) {
          const maSeries = chart.addLineSeries({
            color: color,
            lineWidth: 2,
          });
          const maData = data
            .filter(d => d[key] != null)
            .map(d => ({ time: d.Date, value: d[key] }));
          maSeries.setData(maData);
        }
      }

      // 自适应尺寸
      window.addEventListener('resize', () => {
        chart.resize(chartContainer.clientWidth, chartContainer.clientHeight);
      });
      chart.resize(chartContainer.clientWidth, chartContainer.clientHeight);

    } catch (err) {
      loadingEl.style.display = 'none';
      errorEl.style.display = 'block';
      errorEl.textContent = '图表加载或绘制出错: ' + err.message;
      console.error(err);
    }
  })();
});
</script>
</body>
</html>
