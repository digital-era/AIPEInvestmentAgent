<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>均线分析</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Luxon 时间处理库 + 适配器 -->
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"></script>

  <!-- 金融图插件 -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@1.0.0-beta.15/dist/chartjs-chart-financial.min.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: #181818;
      color: #EAEAEA;
      font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
      display: flex;
      flex-direction: column;
    }
    header {
      padding: 20px;
      border-bottom: 1px solid #3A3A3A;
      text-align: center;
      font-size: 2rem;
      color: #a0d2eb;
    }
    #chartContainer {
      flex: 1;
      padding: 20px 25px;
    }
    #popupMaChart {
      width: 100%;
      height: 100%;
      background: #222;
    }
    #loading {
      text-align: center;
      padding: 50px;
      font-size: 1.5rem;
      color: #bbb;
    }
  </style>
</head>
<body>
  <header id="chartTitle">均线分析</header>
  <div id="chartContainer">
    <canvas id="popupMaChart"></canvas>
    <div id="loading">正在加载数据...</div>
  </div>

  <script>
    (async function () {
      const { Chart } = window;

      // 注册所有必要的组件
      Chart.register(
        Chart.FinancialController,
        Chart.CandlestickController,
        Chart.CandlestickElement,
        Chart.FinancialScale,
        Chart.TimeScale,
        Chart.LinearScale,
        Chart.BarController,
        Chart.BarElement,
        Chart.Tooltip,
        Chart.Legend,
        window['chartjs-adapter-luxon']
      );

      function getQueryParam(name) {
        return new URLSearchParams(window.location.search).get(name) || '';
      }

      const stockCode = getQueryParam('code');
      const stockName = getQueryParam('name') || stockCode;

      if (!stockCode) {
        alert('缺少股票代码参数！');
        return;
      }

      document.getElementById('chartTitle').textContent = `均线分析: ${stockName} (${stockCode})`;
      document.title = `均线分析 - ${stockName} (${stockCode})`;

      const loadingDiv = document.getElementById('loading');
      const canvas = document.getElementById('popupMaChart');
      canvas.style.display = 'none';

      try {
        const response = await fetch(`/api/rtStockQueryProxy?code=${encodeURIComponent(stockCode)}&type=movingaveragedata`);
        if (!response.ok) throw new Error('请求失败: ' + response.status);

        const data = await response.json();
        if (!Array.isArray(data) || data.length === 0) throw new Error('无有效数据');

        const candlestickData = data.map(d => ({
          x: luxon.DateTime.fromISO(d.Date).toMillis(),
          o: d.Open,
          h: d.High,
          l: d.Low,
          c: d.Close
        }));

        const volumeData = data.map(d => ({
          x: luxon.DateTime.fromISO(d.Date).toMillis(),
          y: d.Volume
        }));

        const volumeColors = data.map(d =>
          d.Close >= d.Open ? 'rgba(46, 204, 113, 0.7)' : 'rgba(231, 76, 60, 0.7)'
        );

        const maConfigs = [
          { period: 5, color: '#e67e22' },
          { period: 10, color: '#3498db' },
          { period: 20, color: '#9b59b6' },
          { period: 30, color: '#f1c40f' },
          { period: 60, color: '#2ecc71' },
          { period: 120, color: '#e74c3c' },
          { period: 250, color: '#bdc3c7' }
        ];

        const maDatasets = [];
        for (const config of maConfigs) {
          const key = 'MA_' + config.period;
          if (data.some(d => d[key] != null)) {
            const maData = data.map(d => ({
              x: luxon.DateTime.fromISO(d.Date).toMillis(),
              y: d[key]
            })).filter(d => d.y != null);

            maDatasets.push({
              type: 'line',
              label: 'MA' + config.period,
              data: maData,
              borderColor: config.color,
              borderWidth: 1.5,
              pointRadius: 0,
              yAxisID: 'y'
            });
          }
        }

        loadingDiv.style.display = 'none';
        canvas.style.display = 'block';
        const ctx = canvas.getContext('2d');

        new Chart(ctx, {
          type: 'bar',
          data: {
            datasets: [
              {
                type: 'candlestick',
                label: 'K线',
                data: candlestickData,
                yAxisID: 'y'
              },
              ...maDatasets,
              {
                type: 'bar',
                label: '成交量',
                data: volumeData,
                backgroundColor: volumeColors,
                yAxisID: 'yVolume'
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
              legend: { labels: { color: '#EAEAEA' } },
              tooltip: {
                backgroundColor: '#333',
                titleColor: '#fff',
                bodyColor: '#eee',
                callbacks: {
                  label: ctx => {
                    const raw = ctx.raw;
                    const label = ctx.dataset.label || '';
                    if (ctx.dataset.type === 'bar') {
                      const val = raw.y;
                      if (val >= 1e8) return label + ': ' + (val / 1e8).toFixed(2) + '亿';
                      if (val >= 1e4) return label + ': ' + (val / 1e4).toFixed(2) + '万';
                      return label + ': ' + val;
                    }
                    if (raw && raw.c !== undefined) {
                      return `开:${raw.o.toFixed(2)} 高:${raw.h.toFixed(2)} 低:${raw.l.toFixed(2)} 收:${raw.c.toFixed(2)}`;
                    }
                    return label + ': ' + ctx.formattedValue;
                  }
                }
              }
            },
            scales: {
              x: {
                type: 'time',
                time: { unit: 'day', tooltipFormat: 'yyyy-MM-dd' },
                ticks: { color: '#90A4AE' },
                grid: { drawOnChartArea: false }
              },
              y: {
                position: 'left',
                ticks: { color: '#90A4AE' },
                grid: { color: 'rgba(255,255,255,0.1)' }
              },
              yVolume: {
                position: 'right',
                grid: { drawOnChartArea: false },
                ticks: {
                  color: '#90A4AE',
                  callback: val => {
                    if (val >= 1e8) return (val / 1e8).toFixed(0) + '亿';
                    if (val >= 1e4) return (val / 1e4).toFixed(0) + '万';
                    return val;
                  }
                }
              }
            }
          }
        });

      } catch (err) {
        console.error('图表渲染失败:', err);
        loadingDiv.textContent = '图表渲染失败: ' + err.message;
      }
    })();
  </script>
</body>
</html>
