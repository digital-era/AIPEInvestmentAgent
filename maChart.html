<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>均线分析图</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background-color: #111;
      color: #eee;
      font-family: "Segoe UI", "Microsoft YaHei", sans-serif;
    }
    header {
      padding: 16px;
      font-size: 1.5rem;
      text-align: center;
      background-color: #222;
      color: #00bcd4;
    }
    #chart {
      width: 100%;
      height: calc(100vh - 64px);
    }
    #loading {
      text-align: center;
      padding: 50px;
      font-size: 1.25rem;
    }
  </style>
  <script src="https://unpkg.com/lightweight-charts@4.0.1/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>
  <header id="chartTitle">均线图加载中...</header>
  <div id="chart"></div>
  <div id="loading">正在加载数据...</div>

  <script>
    (async function() {
      function getQueryParam(name) {
        return new URLSearchParams(window.location.search).get(name) || '';
      }

      const stockCode = getQueryParam('code');
      const stockName = getQueryParam('name');

      document.getElementById('chartTitle').textContent = `均线图：${stockName} (${stockCode})`;

      const response = await fetch(`/api/rtStockQueryProxy?code=${encodeURIComponent(stockCode)}&type=movingaveragedata`);
      if (!response.ok) {
        document.getElementById('loading').textContent = '数据加载失败';
        return;
      }

      const rawData = await response.json();
      if (!Array.isArray(rawData) || rawData.length === 0) {
        document.getElementById('loading').textContent = '无可用数据';
        return;
      }

      document.getElementById('loading').style.display = 'none';
      const chartDiv = document.getElementById('chart');

      const chart = LightweightCharts.createChart(chartDiv, {
        layout: {
          background: { color: '#111' },
          textColor: '#ccc'
        },
        grid: {
          vertLines: { color: '#222' },
          horzLines: { color: '#222' }
        },
        timeScale: {
          timeVisible: true,
          secondsVisible: false
        },
        width: chartDiv.clientWidth,
        height: chartDiv.clientHeight
      });

      window.addEventListener('resize', () => {
        chart.resize(chartDiv.clientWidth, chartDiv.clientHeight);
      });

      const candlestickSeries = chart.addCandlestickSeries();
      const maSeries = {};

      const maPeriods = [5, 10, 20, 30, 60, 120, 250];
      const maColors = {
        5: '#ff9800',
        10: '#03a9f4',
        20: '#8e44ad',
        30: '#ffeb3b',
        60: '#4caf50',
        120: '#e91e63',
        250: '#9e9e9e'
      };

      maPeriods.forEach(period => {
        maSeries[period] = chart.addLineSeries({
          color: maColors[period],
          lineWidth: 1.5
        });
      });

      const candlestickData = [];
      const maData = {};

      maPeriods.forEach(p => maData[p] = []);

      rawData.forEach(item => {
        const time = new Date(item.Date).getTime() / 1000;

        candlestickData.push({
          time,
          open: item.Open,
          high: item.High,
          low: item.Low,
          close: item.Close
        });

        maPeriods.forEach(period => {
          if (item[`MA_${period}`]) {
            maData[period].push({ time, value: item[`MA_${period}`] });
          }
        });
      });

      candlestickSeries.setData(candlestickData);
      maPeriods.forEach(period => {
        maSeries[period].setData(maData[period]);
      });
    })();
  </script>
</body>
</html>
