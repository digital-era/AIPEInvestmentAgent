<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>均线分析</title>

<!-- 核心库 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0/build/global/luxon.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.1.0/dist/chartjs-chart-financial.min.js"></script>

<style>
  html, body {
    margin: 0; padding: 0; height: 100%;
    background: #181818;
    color: #EAEAEA;
    font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
    display: flex;
    flex-direction: column;
  }
  header {
    padding: 20px;
    border-bottom: 1px solid #3A3A3A;
    text-align: center;
    font-size: 2rem;
    color: #a0d2eb;
  }
  #chartContainer {
    flex: 1;
    padding: 20px 25px;
  }
  #popupMaChart {
    width: 100%;
    height: 100%;
    background: #222;
    border-radius: 8px;
  }
</style>
</head>
<body>
<header id="chartTitle">均线分析</header>
<div id="chartContainer">
  <canvas id="popupMaChart"></canvas>
</div>

<script>
(async function(){
  // 注册Luxon适配器（Chart.js初始化前必须）
  Chart.register(window.chartjsAdapterLuxon);

  function getQueryParam(name) {
    return new URLSearchParams(window.location.search).get(name) || '';
  }

  const stockCode = getQueryParam('code');
  const stockName = getQueryParam('name') || stockCode;

  if (!stockCode) {
    alert('缺少股票代码参数！');
    return;
  }

  document.getElementById('chartTitle').textContent = `均线分析: ${stockName} (${stockCode})`;
  document.title = `均线分析 - ${stockName} (${stockCode})`;

  try {
    const response = await fetch(`/api/rtStockQueryProxy?code=${encodeURIComponent(stockCode)}&type=movingaveragedata`);
    if (!response.ok) {
      throw new Error(`请求失败，状态码: ${response.status}`);
    }

    const data = await response.json();
    if (!Array.isArray(data) || data.length === 0) {
      throw new Error('API未返回有效数据');
    }

    // 处理K线数据
    const candlestickData = data.map(d => ({
      x: luxon.DateTime.fromISO(d.Date).toMillis(),
      o: d.Open,
      h: d.High,
      l: d.Low,
      c: d.Close
    }));

    // 处理成交量数据
    const volumeData = data.map(d => ({
      x: luxon.DateTime.fromISO(d.Date).toMillis(),
      y: d.Volume
    }));

    // 成交量颜色，涨绿跌红
    const volumeColors = data.map(d => d.Close >= d.Open ? 'rgba(46, 204, 113, 0.7)' : 'rgba(231, 76, 60, 0.7)');

    // 多条均线配置
    const maConfigs = [
      { period: 5, color: '#e67e22' },
      { period: 10, color: '#3498db' },
      { period: 20, color: '#9b59b6' },
      { period: 30, color: '#f1c40f' },
      { period: 60, color: '#2ecc71' },
      { period: 120, color: '#e74c3c' },
      { period: 250, color: '#bdc3c7' }
    ];

    const maDatasets = [];
    for (const config of maConfigs) {
      const key = 'MA_' + config.period;
      if (data.some(d => d[key] != null)) {
        const maData = data.map(d => ({
          x: luxon.DateTime.fromISO(d.Date).toMillis(),
          y: d[key]
        })).filter(d => d.y != null);
        maDatasets.push({
          type: 'line',
          label: 'MA' + config.period,
          data: maData,
          borderColor: config.color,
          borderWidth: 1.5,
          pointRadius: 0,
          yAxisID: 'y'
        });
      }
    }

    const ctx = document.getElementById('popupMaChart').getContext('2d');

    // 图表区域拆分插件（价格区+成交量区）
    const chartAreaSplitter = {
      id: 'chartAreaSplitter',
      beforeDraw(chart) {
        const {ctx, chartArea, scales} = chart;
        if (!scales.y || !scales.yVolume) return;

        const priceRatio = 0.7;
        const gap = 20;

        scales.y.height = chartArea.height * priceRatio;
        scales.y.bottom = chartArea.top + scales.y.height;

        scales.yVolume.height = chartArea.height * (1 - priceRatio) - gap;
        scales.yVolume.top = scales.y.bottom + gap;
      }
    };

    new Chart(ctx, {
      type: 'bar', // 主体类型为柱状图，K线作为子类型
      data: {
        datasets: [
          {
            type: 'candlestick',
            label: 'K线',
            data: candlestickData,
            yAxisID: 'y'
          },
          ...maDatasets,
          {
            type: 'bar',
            label: '成交量',
            data: volumeData,
            backgroundColor: volumeColors,
            yAxisID: 'yVolume'
          }
        ]
      },
      options: {
        maintainAspectRatio: false,
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { position: 'top', labels: { color: '#EAEAEA' } },
          tooltip: {
            backgroundColor: 'rgba(40,40,40,0.95)',
            titleColor: '#B0BEC5',
            bodyColor: '#EAEAEA',
            padding: 10,
            callbacks: {
              label(ctx) {
                const raw = ctx.raw;
                const label = ctx.dataset.label || '';
                if (ctx.dataset.type === 'bar') {
                  let val = raw.y;
                  if (val >= 1e8) return label + ': ' + (val / 1e8).toFixed(2) + '亿';
                  if (val >= 1e4) return label + ': ' + (val / 1e4).toFixed(2) + '万';
                  return label + ': ' + val;
                }
                if (raw && raw.c !== undefined) {
                  return `开:${raw.o.toFixed(2)} 高:${raw.h.toFixed(2)} 低:${raw.l.toFixed(2)} 收:${raw.c.toFixed(2)}`;
                }
                return label + ': ' + ctx.formattedValue;
              }
            }
          }
        },
        scales: {
          x: {
            type: 'time',
            time: { unit: 'day', tooltipFormat: 'yyyy-MM-dd' },
            grid: { drawOnChartArea: false },
            ticks: { color: '#90A4AE', source: 'auto', maxRotation: 0 }
          },
          y: {
            position: 'left',
            grid: { color: 'rgba(255,255,255,0.1)' },
            ticks: { color: '#90A4AE' }
          },
          yVolume: {
            position: 'right',
            grid: { drawOnChartArea: false },
            ticks: {
              color: '#90A4AE',
              callback(value) {
                if (value >= 1e8) return (value / 1e8).toFixed(0) + '亿';
                if (value >= 1e4) return (value / 1e4).toFixed(0) + '万';
                return value;
              }
            }
          }
        }
      },
      plugins: [chartAreaSplitter]
    });

  } catch (error) {
    console.error('图表渲染失败:', error);
    alert('图表渲染失败: ' + error.message);
  }
})();
</script>

</body>
</html>
