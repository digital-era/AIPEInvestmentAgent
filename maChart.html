<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>均线分析 - LightweightCharts 示例</title>

  <!-- 引入 LightweightCharts 库，确保不要加 defer -->
  <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.4.0/dist/lightweight-charts.standalone.production.js"></script>

  <style>
    html, body {
      margin: 0; padding: 0; height: 100%;
      background: #181818;
      color: #EAEAEA;
      font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
      display: flex; flex-direction: column;
    }
    header {
      padding: 20px;
      border-bottom: 1px solid #3A3A3A;
      text-align: center;
      font-size: 2rem;
      color: #a0d2eb;
    }
    #chartContainer {
      flex: 1;
      padding: 20px 25px;
    }
    #chart {
      width: 100%;
      height: 600px;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <header id="chartTitle">均线分析示例</header>
  <div id="chartContainer">
    <div id="chart"></div>
  </div>

  <script>
    // 等待 DOM 和 LightweightCharts 加载完成后执行
    window.addEventListener('DOMContentLoaded', () => {
      if (!window.LightweightCharts) {
        alert('LightweightCharts 库加载失败，请检查网络连接和脚本引用。');
        return;
      }

      const chart = LightweightCharts.createChart(document.getElementById('chart'), {
        layout: {
          backgroundColor: '#181818',
          textColor: '#EAEAEA',
        },
        rightPriceScale: {
          borderColor: '#555',
        },
        timeScale: {
          borderColor: '#555',
          timeVisible: true,
          secondsVisible: false,
        },
        grid: {
          vertLines: { color: '#444' },
          horzLines: { color: '#444' },
        },
      });

      // K线数据示例
      const candleSeries = chart.addCandlestickSeries({
        upColor: '#26a69a',
        downColor: '#ef5350',
        borderDownColor: '#ef5350',
        borderUpColor: '#26a69a',
        wickDownColor: '#ef5350',
        wickUpColor: '#26a69a',
      });

      // 模拟的历史K线数据，格式要正确
      const candleData = [
        { time: '2023-06-01', open: 100, high: 105, low: 95, close: 102 },
        { time: '2023-06-02', open: 102, high: 108, low: 101, close: 107 },
        { time: '2023-06-05', open: 107, high: 110, low: 104, close: 106 },
        { time: '2023-06-06', open: 106, high: 109, low: 103, close: 104 },
        { time: '2023-06-07', open: 104, high: 107, low: 101, close: 105 },
        { time: '2023-06-08', open: 105, high: 108, low: 102, close: 107 },
        { time: '2023-06-09', open: 107, high: 111, low: 106, close: 110 },
      ];
      candleSeries.setData(candleData);

      // 简单计算均线函数（简单移动平均）
      function calculateSMA(data, period) {
        const sma = [];
        for (let i = 0; i < data.length; i++) {
          if (i < period - 1) {
            sma.push({ time: data[i].time, value: null });
            continue;
          }
          let sum = 0;
          for (let j = i - period + 1; j <= i; j++) {
            sum += data[j].close;
          }
          sma.push({ time: data[i].time, value: sum / period });
        }
        return sma;
      }

      // 添加均线系列
      const maPeriods = [5, 10, 20];
      const maColors = ['#e67e22', '#3498db', '#9b59b6'];

      maPeriods.forEach((period, idx) => {
        const lineSeries = chart.addLineSeries({
          color: maColors[idx],
          lineWidth: 2,
        });
        const maData = calculateSMA(candleData, period).filter(d => d.value !== null);
        lineSeries.setData(maData);
      });
    });
  </script>
</body>
</html>
